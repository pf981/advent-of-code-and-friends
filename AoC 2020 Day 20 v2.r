# Databricks notebook source
# MAGIC %md https://adventofcode.com/2020/day/20

# COMMAND ----------

library(tidyverse)

# COMMAND ----------

input <- "Tile 1621:
.#.##...#.
#..#..#.#.
#.#..#..##
.....#..#.
.#..#...##
#....#...#
.#........
#.#.#....#
...#...#..
.#..#....#

Tile 3671:
..#.#.###.
#.##....##
#.........
##..#.#...
#..###....
..#.#....#
##..###..#
..#......#
.........#
......###.

Tile 2803:
#.#.#..#..
#.....#...
...##..###
#.#.....##
#...#..#.#
..#...##.#
..#...#..#
####.#..##
#..##....#
#..#.##.#.

Tile 1531:
####.#####
.###...###
##..#..#.#
##.#..#..#
#....#..##
##.#....#.
#.#.##....
....#..#..
#...#.....
##....#...

Tile 1811:
#.#...#..#
##....#.##
#...##.#..
#..##.....
.#.#.....#
##..#.....
##.#......
..#...##..
.#.##....#
##...##..#

Tile 2143:
##.###.#.#
#..##.##..
###.......
..##.#...#
#.......#.
#.#....##.
...#..####
..##...#.#
#.#..#.##.
#.#.#...##

Tile 2887:
.......##.
#..#..#..#
....#.....
...#..##..
..#.......
#...##..##
..#...##..
#.....#.##
##..#..##.
#...#.####

Tile 3511:
.#.##....#
#.#...##.#
#...##.###
....#.....
..#......#
.###.#..#.
#.........
#.#....###
.......#.#
#..#######

Tile 3911:
.#..#.###.
#...#.##..
.#..#...##
##.#.##.##
....#.#..#
...###....
.....#...#
...##..#..
###.#.#.#.
##.....#.#

Tile 3821:
#####..#..
##..#.....
....##.#.#
#....#....
#...##.#.#
#........#
####......
#.#.#....#
....######
..#...###.

Tile 3539:
#####.##..
#........#
####.#....
.##..#.#.#
#.....#...
#.#......#
##...###.#
.#..#.....
#.#.......
...#...#..

Tile 3251:
....#..##.
.###.#...#
#..#.....#
...#.....#
..#.......
.##..#...#
#.......##
#.....#...
....#..#.#
######.#.#

Tile 2677:
.#...#...#
...#.###..
......##..
#.##.##...
#.#...#.##
#..#####..
......##..
......##.#
#..#..#...
..##.####.

Tile 3011:
#.#..#..##
#.###..#..
#..#..##..
#.#..#...#
##...#####
....#..###
.#..#..#.#
..#...#..#
##.##..#.#
.#.##.....

Tile 1489:
#...##.###
#.#..#....
#.....#..#
##..#.....
...#....##
.##.##.#.#
#.#......#
#........#
....#.....
##.#.#####

Tile 3769:
.....####.
##....####
###....#.#
.##..#.#.#
..........
##....####
#...#..#..
...#.....#
##.#.....#
#...##.###

Tile 2293:
.#..#.#...
####......
##...#....
###.#.#...
.##.##...#
......#.#.
##.....#..
#..#.##.##
.##....##.
.#.....#..

Tile 3947:
.#.#...##.
..........
..#...##.#
..###..#.#
##...#.###
.#..#..#..
#.#....#..
....#.#..#
.#....####
######..#.

Tile 1223:
#..#####.#
###..#..##
##.###....
...##.#...
..#.##.#..
##.###...#
...#..#.##
...#..#...
.#....#..#
#..####...

Tile 3331:
#.....##..
##..###.#.
.##.#...#.
.##..#.#..
#......#..
...#.....#
###.#.#...
.##......#
#..#......
...#...###

Tile 3691:
#..#..#.##
......#..#
#.#..##..#
###.......
#.#....##.
##.#..##..
#......#..
..#.......
...#.#..#.
#..#......

Tile 1289:
#.......#.
##.##....#
####......
.#..#.#..#
#.#.#..###
#..#......
##.#####..
.#........
##.##....#
##.#######

Tile 2857:
.#.#..#.##
.....#.#..
#..#...#..
.##...#..#
##..#..#.#
#..#..#..#
...#......
#.#.#.....
##...#....
....#.##..

Tile 3559:
#.##..##..
..#.##.###
##..#....#
#.#..#..#.
##.####..#
.....#...#
#....#....
##..#.##..
#..#.....#
###.##..##

Tile 2633:
...#.#..##
##.......#
#...##..#.
#.#....#.#
.........#
...#.....#
.#.##....#
...#..#...
#.#.##....
..#..##...

Tile 1973:
#.#.....#.
#.......#.
#....#....
.#.#...##.
.........#
#.......#.
...#.##..#
.##...#...
##..#..#..
####..##.#

Tile 1373:
#####.#..#
##.##..###
#.####...#
..###.#...
....##...#
#...#....#
##.#....##
.......#..
##.#.##.#.
#.###.##.#

Tile 1759:
.#.....##.
#.#..#...#
....###..#
........##
....#.....
.....#..#.
#...#....#
.#..#...#.
...#.#.#..
##...#..##

Tile 1213:
#....###.#
###...##.#
.#.....#.#
#......##.
.#...#.##.
.##.......
....##...#
#.........
.........#
#.....#.##

Tile 2341:
#.....#.#.
...##.#..#
.....##..#
......##.#
#...#....#
..#...###.
..##.#.#.#
.#.#....##
.#.....###
.#.#...##.

Tile 3547:
####.#.#.#
...###...#
#..#.##...
##..#.#...
#....#.#.#
.#.......#
.#.#......
###.....#.
#.#....###
.#.##.#...

Tile 2003:
#####.####
...#..#..#
.#.......#
#.#.#...##
.#.#.#..#.
#......#..
...#..#...
.#...#.#..
#........#
####.###..

Tile 2861:
#..##.##..
..#.#....#
....##.#..
##........
#.........
##.....#.#
##.....##.
####.....#
###..#####
.........#

Tile 3697:
#..##.####
.....#....
#.#.#.#.#.
#.##...###
..##.....#
.#.......#
.##.......
#.#..#...#
.#.###.#..
####.####.

Tile 3929:
.#.##..#.#
##.#....##
....#.#..#
....#.#.#.
##........
...#..#...
###....#.#
#........#
.###.##.##
###..#####

Tile 3527:
#.#.#...#.
####.#....
......#...
.##......#
.#......##
.##.#.#.##
#..#......
#.....#...
.#........
..#..####.

Tile 1777:
.#..#...##
#....###..
..#..##.##
..##...#..
....#.#...
#...##.#..
#..##.#..#
...##.....
.#....#..#
.#..#..###

Tile 1543:
......#...
.#...##...
#...#..#.#
..........
#..##....#
..#.#...##
...#.####.
##....#...
...#..####
.#.#..####

Tile 2063:
##....#...
#.....#...
###.##...#
......#..#
...##..#..
###.#.....
##.....##.
#..#.##...
##.###..##
#....###..

Tile 1181:
#.##...###
####.#....
.........#
####..##.#
.....#..#.
.......#..
..###....#
##..##....
#.#...#..#
.#.#.#...#

Tile 3491:
#...###.##
..##..#.##
.......##.
..........
.....#..#.
#..#......
##....#.#.
...##...#.
..###.....
..#.##..#.

Tile 1873:
...#.....#
...#.#..#.
##.#......
.#...#.###
#.#.#..#..
.....###.#
#..#..#...
....#.....
.....#.#.#
######...#

Tile 2579:
.####...#.
#..#..#..#
.....#...#
#.#..#...#
#.....##..
......#..#
#......##.
.#...##...
.#...##...
.##.####..

Tile 1481:
.#.#.#####
..#.#.##..
.###...#.#
...##.....
..#.#.#.#.
.#.......#
##.#....#.
#.#...#...
.###..#...
......##.#

Tile 2417:
.#..#..#.#
.#.#.....#
.###..##.#
#.#.#.....
#....#.###
..#..#....
#....#.#..
####....##
..#.#...##
....######

Tile 3581:
..##.....#
.....##..#
#.........
#....##..#
#..#....#.
#.....#..#
.#..#.#.#.
...#......
.....##..#
#.........

Tile 3593:
#.##.###..
###.....##
##.#....#.
###.#....#
###....#.#
#.#..#..##
......#.##
...#....#.
.#...#..#.
..#####..#

Tile 3167:
#...#.#.#.
......#.##
##.##.#.##
#...#.##.#
....#...#.
..#....##.
...#...##.
...##..#..
....#.##.#
##.#....#.

Tile 1439:
...##..###
#.#......#
..#..###.#
....#.#...
#.........
......#..#
..#.#.#..#
##.#.#....
..#...#..#
#.###.#...

Tile 1249:
..#.##...#
#.#......#
.......#..
##.#.#.#.#
.#..#..#..
..#.#..#.#
.....##.#.
#........#
..#..##.##
..#..#####

Tile 2687:
##...##...
###.###.#.
#...###..#
.#.......#
....#.#...
.....#####
##.#####..
#....#....
..#.####.#
##....#.#.

Tile 2693:
..#..#..#.
....#..###
....##....
.#.##.....
.#..###...
..##.#....
#.........
....##.##.
..#..#....
.#.#......

Tile 1741:
.#.###..##
......####
#.......##
#.#......#
##..#...#.
##.....#.#
#..#......
..##.#..##
#..#......
#.#..###.#

Tile 3413:
...####.#.
.#..#.##..
#....#.##.
##.#.....#
##.###..##
.......###
.#....###.
#....##..#
##.####..#
....#.###.

Tile 3191:
.....####.
##.##..#..
.##.#.##.#
.......###
....####..
.#.#..#.#.
...#...#..
##..#..#.#
...#..#...
..##..#.#.

Tile 2897:
#.#######.
...#....#.
#.....##.#
###.#...#.
##.#####.#
..#.##..##
#.##......
##.#.##..#
#.#....#..
#.##.#.###

Tile 2017:
##.##...##
#...#.##..
#..#.#...#
.##.......
##.......#
##..#.#..#
##.#.#.#.#
..........
..........
..######.#

Tile 2939:
#...##.##.
.....#.##.
....#.#...
#.#......#
.#.....#.#
.........#
###.....##
......#..#
#..#..##..
.##..#.##.

Tile 1753:
#...#.#.##
.#...#...#
###..#.###
#..##....#
#..#......
#.##...#..
..#...#...
#..#......
.#.......#
....#.#.##

Tile 3229:
#..####.#.
#.....#..#
......##..
#.#...##.#
#...#...##
#.#....#.#
.#..##..#.
#..#.....#
#..##.....
.#.#.#..##

Tile 1367:
####.....#
...#.##...
...#...#..
.#.###..#.
.........#
.#........
..........
.#...###.#
##........
...##..#.#

Tile 2851:
..#.#...##
#.....##.#
.##.#..#.#
#...###..#
###...#...
....#..#.#
..#.......
#.....#...
...#.#...#
.###..#..#

Tile 2357:
....##.#.#
###...#.##
####..##.#
#.####...#
#...##...#
#.#......#
#..##.#.#.
#.#....#.#
.###...#..
####..#.##

Tile 1697:
#..#.#.##.
.......#..
...##....#
##........
....#....#
##.#.....#
.##......#
#....#..#.
##.##...##
#....#...#

Tile 1571:
#.###...#.
##..#..#..
.........#
...#.#.#..
#........#
#..##.#...
##...##.#.
..........
....#.#...
.##.....#.

Tile 3323:
#.#.#..###
#...#...##
.......#.#
#.##......
..#.#..##.
#.......#.
....####.#
....##...#
..##....##
######.###

Tile 3461:
#....##.#.
....#.....
#......##.
##.....##.
#..#...##.
.#.......#
##.#......
..........
.....#..##
.....#.###

Tile 2719:
.#.#.#....
..#..#.##.
..##...###
..#..#...#
##.......#
.#........
.##..#....
..##..#...
..#....#..
.#.#.#..#.

Tile 3359:
.###...#.#
.....###.#
#..####.#.
.....##..#
..#.#...#.
#.#..###..
..#....#.#
....#.#..#
.....#..#.
#.###.#..#

Tile 3803:
.####.#..#
...#...###
.......##.
.......##.
#..#..#..#
##...#....
....##....
##........
..#..#####
..#..##...

Tile 3019:
##..###.#.
..#.......
##..#.##.#
##......#.
#......#..
#.#....#..
.###.###.#
#..#.##..#
###.##.#.#
.###.###.#

Tile 2791:
......#.#.
#....#....
##...#####
....##....
#.....##.#
..##......
#.#...#..#
...##...#.
..##....#.
##.##..#..

Tile 3881:
#....##..#
...#..#..#
.###..#..#
...#....##
#...#..#.#
#.#.#..#.#
#..##.....
...#......
#.#....#..
.#..##.###

Tile 2087:
.#..#.#...
###....###
.###..#.##
........##
###.##..##
...#...#.#
#...#....#
##..#....#
#..####.#.
##..#####.

Tile 1789:
######.#..
........#.
..#...##.#
.#.......#
.#...#....
#..#.#..##
#####.#..#
#...###..#
.#.#....##
####.##.#.

Tile 2539:
#.###.#..#
..#..#...#
##.##.#...
#.....##..
#..##..#..
..###.##.#
#..###...#
.###.#.#..
#...#.....
..###.##..

Tile 2111:
####..###.
#....###..
..#.....##
#....##.##
#.....#...
#..#.#....
...#..####
##..##..#.
##.....#.#
#.#...#.#.

Tile 1433:
#.....#..#
.#.###.#.#
.#...#.#.#
.......###
#..##.#...
.#...##.#.
#..#....##
#......#..
....#..#.#
..#.#..##.

Tile 1667:
..##......
#..#....#.
.##.#..#.#
.....#....
#.#.##..#.
...##.....
..#.#....#
#.#..#...#
...#...##.
....#....#

Tile 2389:
.#.#...#..
.#.......#
.....#....
#...###..#
..........
.#........
.#.###.#.#
#....#..#.
..#......#
##...#...#

Tile 1069:
...###..##
...#.....#
##......##
....##....
..#..##..#
##..#..#.#
##.#.#.#.#
.#..###..#
#.#.......
.#.#.#....

Tile 1103:
..###.##..
...##..#.#
#....##..#
....#..#.#
#....#.#..
###....###
..#...##..
..##.....#
#........#
.####..#..

Tile 3761:
....#.##..
###.......
#...#.....
..##.#...#
#........#
.###......
...#..#...
...#.#.#..
#....#.#.#
....#...#.

Tile 2473:
........##
.#.#..#...
.#........
.####.#.##
##..##...#
##.....#..
###.#..#.#
..........
.#.#..##.#
..#....#.#

Tile 1987:
...#..#.#.
......#...
#....#.###
..#....#..
..#..##..#
........#.
#..#.....#
...#..#..#
.......#.#
...###.##.

Tile 1187:
..#.#.#..#
##.#...##.
#......#.#
....#....#
..##...#.#
#..#..#.##
..........
..##...#.#
...####..#
.#.#.#####

Tile 2699:
###.#.##.#
.#.#####.#
.#..#..#..
.###....##
..#..##..#
.....#...#
..........
#...##...#
#.........
##..#..#.#

Tile 3643:
..##...#..
#..#..#.##
#.###.####
..##..##..
......#...
##.##..#..
...#.##.##
....#..#.#
##..#....#
#....#...#

Tile 3463:
..###.##.#
......##.#
#........#
......##.#
##.......#
##..#..#.#
##.......#
##......#.
##.#.##...
.###..#.##

Tile 1117:
#.#.##....
..#..#.###
.#..#.....
...#.#....
........#.
##.###...#
..#..#.#.#
....#..#..
..#.#....#
..#.#..#..

Tile 1163:
.##.##..##
....#..#..
##..#..#..
#..#.....#
#..#.....#
..#.##....
...#.#....
..###..#.#
...#...#.#
###.######

Tile 3557:
#.#....#..
....####.#
.#....####
..#...###.
#......#..
.......#..
##....#...
##.....#..
...#..#.#.
...###.#..

Tile 2467:
.####....#
.#.#..##.#
####......
......#.#.
#.#....#.#
##.....#..
..#....#.#
..#.##...#
.#.....###
#...##.##.

Tile 1471:
.###..#.##
##.#...##.
.#...#....
....##..#.
........#.
##....##.#
###..##.#.
#....###.#
##.....##.
#..#..##.#

Tile 3931:
#....#..##
#...#..#..
.#..######
#.###...#.
....#.##.#
#.#...####
#....#..#.
....##.#..
#..#..####
#.#.#.....

Tile 2029:
##.#.#####
#.#......#
#...##...#
#...#.....
#..##.....
#.....##.#
....##....
..##.#.###
###.#.###.
..####.##.

Tile 1913:
#..###.###
.......###
.#..#.####
.#..#.#...
..#.......
.#....###.
.###..#.#.
#....#..#.
#.#..#.#..
.#..#.#.#.

Tile 2213:
..#.##.###
......###.
..#..#...#
#..#..#.##
#....###..
...#....#.
#.##.#..#.
##.#...#..
.##....###
####.#..#.

Tile 1511:
###.#...##
.##.....#.
.##...#..#
...##.##..
#.#..#.#.#
##...###.#
###..#.###
.##.##..#.
#......#..
###.....##

Tile 2243:
#..#.#...#
##...#....
.....#.#.#
....##..#.
#..######.
.#..#.##..
#.........
...#.##.#.
.#.......#
.##...#.##

Tile 3701:
...#######
#..#...##.
...####..#
..#..#...#
##........
#.....#..#
##..#.#...
##.#.##.#.
.##.......
###.#...##

Tile 3137:
.#.####...
#..#.#...#
.......#.#
#..#.....#
#.....#...
#...###.##
.###...#.#
##......##
#.#....#.#
##...####.

Tile 2437:
#...#..###
.#.#....#.
....#...#.
.......#.#
#.#...##.#
###..#...#
#.##..#...
....#.....
#.#.#.##..
.#.#.#.###

Tile 1009:
..#.#.#...
...#..##..
##...##..#
........##
##...###.#
#....#...#
..#..#...#
..####.###
#.........
####..#..#

Tile 2399:
..####.#..
###..#....
#..#..##..
...#.#....
##.##.....
##.###..#.
##..##..##
###....#.#
..#......#
#.###..##.

Tile 2843:
.....#....
......#...
.##.#....#
..#....#..
.##.....##
.#...##.#.
####..##..
.##....##.
....##...#
#..###...#

Tile 1193:
##.....###
.......#..
.#...#.#..
#.#...#.##
..#.....##
.#.....#..
#...#....#
##.#..#.#.
##.....#.#
#..#.....#

Tile 1951:
###......#
..........
..........
#####.....
#.##..#...
.........#
##.##.....
#.#..#.##.
.#...#...#
..#.###...

Tile 1879:
#...#.....
.#.......#
###.......
#####.....
#..#.#....
...###.##.
#.......#.
#.#......#
.#..##....
..#.##.###

Tile 3469:
..####...#
#...#...#.
......###.
........#.
####.....#
#...#...#.
...#....##
#..#..#..#
..#...##.#
#####..#.#

Tile 2161:
####.####.
###...#.##
.##...#...
#..#...#..
##...##.#.
#.........
#...##...#
....#.#..#
..#.##..##
#.......##

Tile 2083:
##.##.#..#
#.##.#..#.
...#.....#
##.#.##.#.
.....#..#.
#.......#.
...###.#.#
....##...#
#.##.#...#
##.#...###

Tile 2089:
#.#.###.#.
#..##.....
.....#...#
#.........
.##...####
#...##...#
.#.......#
....#...##
#..##....#
.....##.#.

Tile 1051:
#.....##.#
.....##.#.
#...#....#
.#.#......
........#.
.......#..
##....#.##
#.......##
#........#
####.##.#.

Tile 3347:
....##.#..
#.#.#..#.#
##........
..#....#..
##...##...
.##.#.....
#........#
#..###....
.....#...#
##.##.#..#

Tile 2927:
#.##......
...#..#.##
.#.#.#.##.
..........
##....#...
##.#...#..
....##.##.
#....#.#..
..#.....#.
##.###.#..

Tile 1301:
#..##.#.#.
#.#......#
..#...#..#
##....#..#
#.........
.......#.#
....##.#..
#..#.###..
..#.######
...###.###

Tile 2459:
#..###....
...###.###
##........
##..#..#..
##.#.##.##
#.##.#..#.
#..##..##.
.#...##..#
#........#
..#.######

Tile 1583:
.#.#..#..#
#.#.#....#
.##.......
.........#
#....#....
##...###.#
#.#.......
.........#
#...#....#
#.###..#.#

Tile 3533:
.#.##.#..#
.#.......#
........#.
.#...#...#
#.........
.......#.#
...#...#..
##..#..#.#
...#.###..
.###..####

Tile 1993:
#.####..#.
..##.#.#.#
.#.#......
.#........
..#.......
#.##..#..#
##..#.....
.#.##..#..
........#.
.#.#.###.#

Tile 3853:
..#.####.#
##....##.#
..#......#
....#.....
.....#.##.
......#..#
..#..#.#.#
##....#...
###.#..##.
##...#.#.#

Tile 2113:
#..#.#.#.#
#.....#.##
#.....#..#
.##....#.#
##.#.#####
#..#......
...#...#..
...#.#..##
.......##.
..##....##

Tile 3319:
####.#..##
##....#.#.
#.......#.
......#..#
####...##.
..........
##.....#..
..#..#..##
#...#.....
.##..#...#

Tile 3847:
...##..#.#
..#.##...#
...#..####
#..#.#.#..
#........#
#....##..#
#....#..##
.#.#.##.##
.####.....
#....##..#

Tile 1283:
..##..###.
##.......#
#.#.#.....
.#.#....#.
..#..#....
#...#.....
##.......#
.##.#...##
##.####...
##..#..###

Tile 2957:
#.####.#.#
#..#..##..
#..###...#
#.#..#.#..
#.......#.
#.#..#...#
######....
#.......##
#...#...#.
.##..#.##.

Tile 1097:
.###.#.###
#......##.
#........#
....#...#.
..##..#.#.
#....#..##
.###...##.
..##.#...#
#..#.####.
#.#.......

Tile 1399:
#.###..###
#...##.###
....#.#...
#...##.#..
..#...#..#
#...###...
.......#..
..#.#.#...
...##...#.
...##..##.

Tile 1451:
#.#...#.#.
#........#
#.#....#.#
###.#.....
....##....
.##.#..#..
.#.####..#
..#..###.#
...#...#.#
#...##.#.#

Tile 1559:
#..#.#.###
......#...
.....#..##
#.........
##..#.....
...#...#..
##.#.#....
.....#.##.
#...#.#.#.
...#####..

Tile 3391:
#.#.#.#..#
##..#.....
.#...###..
......#..#
#.#.....#.
...#..#...
.#......#.
.......#..
.....#.#.#
#.#.#.##.#

Tile 2423:
#.#.#....#
#......#..
#.#.#.#.##
...#.#.#.#
....#.#.#.
.......#..
.##.....#.
.........#
#.#..#...#
...##..##.

Tile 2297:
.....#####
#..#......
#...#.....
##...#.#..
.......##.
#.......#.
###....###
..#.....#.
.....##...
##.##.###.

Tile 2011:
#######...
#.#...#.#.
...##..#..
...##..#.#
......#..#
#..#.....#
...#.#....
....#.#...
..#.###..#
#.#####.#.

Tile 1049:
#.#...#...
.......###
#..#.#..##
##.......#
.#.###...#
##....#...
...#.##...
........#.
...#..#.#.
##...##.##

Tile 3943:
..#...####
...#.##...
#.#.###...
.#...###.#
....#.##..
.##...#..#
####.....#
####.##.#.
##...#....
.##.#...#.

Tile 2039:
#####.#..#
#.#....###
.....#....
##.....#.#
.......#..
#......#..
..#...#..#
#.#...#...
..##...#..
##.#######

Tile 1297:
.#..##.###
#.....#..#
###..##..#
.##..#..##
...#......
#..#....##
..#......#
...##.#..#
....##....
#..###.#..

Tile 1597:
.#..#.##..
###......#
#...##...#
.#.#....##
...##.##..
#.###....#
###.#.....
..#....#.#
...##....#
###.##....

Tile 1319:
...#.##..#
#.#####...
..........
.#..#..#..
#...#.#.#.
.#.##..#..
###.......
#...#.##..
...#.....#
##.#####.#

Tile 2333:
#..##..##.
...#...#.#
..##.#....
#....#.##.
..##..##.#
..##..###.
...##.#..#
.....#.#.#
#......#.#
########..

Tile 1423:
#.##..##..
#.##.....#
#.#..##...
##.#####..
...#.#..#.
.#..#.#.#.
#.##....##
...###..##
#.#.#...#.
#..##.###.

Tile 1303:
.#########
##..#....#
..#.#.####
..........
#...#.....
#.#..#...#
###.#.....
.##.#....#
#.#.#..#..
##..##..#."

# COMMAND ----------

# input <- "Tile 2311:
# ..##.#..#.
# ##..#.....
# #...##..#.
# ####.#...#
# ##.##.###.
# ##...#.###
# .#.#.#..##
# ..#....#..
# ###...#.#.
# ..###..###

# Tile 1951:
# #.##...##.
# #.####...#
# .....#..##
# #...######
# .##.#....#
# .###.#####
# ###.##.##.
# .###....#.
# ..#.#..#.#
# #...##.#..

# Tile 1171:
# ####...##.
# #..##.#..#
# ##.#..#.#.
# .###.####.
# ..###.####
# .##....##.
# .#...####.
# #.##.####.
# ####..#...
# .....##...

# Tile 1427:
# ###.##.#..
# .#..#.##..
# .#.##.#..#
# #.#.#.##.#
# ....#...##
# ...##..##.
# ...#.#####
# .#.####.#.
# ..#..###.#
# ..##.#..#.

# Tile 1489:
# ##.#.#....
# ..##...#..
# .##..##...
# ..#...#...
# #####...#.
# #..#.#.#.#
# ...#.#.#..
# ##.#...##.
# ..##.##.##
# ###.##.#..

# Tile 2473:
# #....####.
# #..#.##...
# #.##..#...
# ######.#.#
# .#...#.#.#
# .#########
# .###.#..#.
# ########.#
# ##...##.#.
# ..###.#.#.

# Tile 2971:
# ..#.#....#
# #...###...
# #.#.###...
# ##.##..#..
# .#####..##
# .#..####.#
# #..#.#..#.
# ..####.###
# ..#.#.###.
# ...#.#.#.#

# Tile 2729:
# ...#.#.#.#
# ####.#....
# ..#.#.....
# ....#..#.#
# .##..##.#.
# .#.####...
# ####.#.#..
# ##.####...
# ##..#.##..
# #.##...##.

# Tile 3079:
# #.#.#####.
# .#..######
# ..#.......
# ######....
# ####.#..#.
# .#...#.##.
# #.#####.##
# ..#.###...
# ..#.......
# ..#.###..."

# COMMAND ----------

str_rev <- stringi::stri_reverse

# COMMAND ----------

parse_tile <- function(x) {
  l <- read_lines(x)
  
  tile_id <- parse_number(l[[1]])
  
  lst(
    tile_id = parse_number(l[[1]]),
    m = str_split(l[-1], "") %>% unlist() %>% matrix(ncol = nchar(l[[2]]), byrow = TRUE)
  )
}

get_edges <- function(tile_info) {
  tile_id <- tile_info$tile_id
  m <- tile_info$m
  tibble(
    tile_id = tile_id,
    north = str_c(m[1,], collapse = ""),
    east = str_c(m[,ncol(m)], collapse = ""),
    south = str_c(rev(m[nrow(m),]), collapse = ""),
    west = str_c(rev(m[,1]), collapse = "")
  )
}

# COMMAND ----------

# parse_tile <- function(x) {
#   l <- read_lines(x)
  
#   tile_id <- parse_number(l[[1]])
  
#   m <- str_split(l[-1], "") %>% unlist() %>% matrix(ncol = nchar(l[[2]]), byrow = TRUE)
  
#   tibble(
#     tile_id = tile_id,
#     north = str_c(m[1,], collapse = ""),
#     east = str_c(m[,ncol(m)], collapse = ""),
#     south = str_c(rev(m[nrow(m),]), collapse = ""),
#     west = str_c(rev(m[,1]), collapse = "")
#   )
# }

# COMMAND ----------

explode <- function(tiles) {
  result <- bind_rows(
    tiles %>% add_column(is_inverted = FALSE),
    tibble(
      tile_id = tiles$tile_id,
      north = str_rev(tiles$north),
      east = str_rev(tiles$west),
      south = str_rev(tiles$south),
      west = str_rev(tiles$east),
      is_inverted = TRUE
    )
  )
  
  result %>%
    mutate(orientation = list(1:4)) %>%
    unnest_longer(orientation) %>%
    mutate(
      n = case_when(
        orientation == 1 ~ north,
        orientation == 2 ~ east,
        orientation == 3 ~ south,
        orientation == 4 ~ west
      ),
      w = case_when(
        orientation == 1 ~ west,
        orientation == 2 ~ north,
        orientation == 3 ~ east,
        orientation == 4 ~ south
      ),
      s = case_when(
        orientation == 1 ~ south,
        orientation == 2 ~ west,
        orientation == 3 ~ north,
        orientation == 4 ~ east
      ),
      e = case_when(
        orientation == 1 ~ east,
        orientation == 2 ~ south,
        orientation == 3 ~ west,
        orientation == 4 ~ north
      )
    ) %>%
    transmute(
      tile_id_original = tile_id,
      tile_id = str_c(tile_id, "_", orientation, ifelse(is_inverted, "i", "")),
      n,
      e,
      s,
      w
    )
}

# COMMAND ----------

# parsed <- parse_tile(x)
# str(parsed)
# explode(parsed)

# COMMAND ----------

tiles_m <-
  input %>%
  str_split("\n\n") %>%
  unlist() %>%
  map(parse_tile)
tiles_m

# COMMAND ----------

tiles <-
  tiles_m %>%
  map_dfr(get_edges)
tiles

# COMMAND ----------

# tiles <-
#   input %>%
#   str_split("\n\n") %>%
#   unlist() %>%
#   map_dfr(parse_tile)
# tiles

# COMMAND ----------

tiles_exploded <- explode(tiles)
display(tiles_exploded)

# COMMAND ----------

tiles_exploded %>% filter(tile_id == "1951_3i")

# COMMAND ----------

place_tile <- function(placed_tile_mat, tiles, to_place_tile_id, i, j, width, debug = FALSE) {
  verbose <- if (debug) message else function(...) invisible()
  
  verbose(paste0("Trying ", to_place_tile_id, " in ", i, ", ", j, "."))
  this_tile <- tiles %>% filter(tile_id == to_place_tile_id)
  
  required_north <- ifelse(
    j > 1,
    str_rev(tiles$s[tiles$tile_id == placed_tile_mat[i, j - 1]]),
    this_tile$n
  )
  required_west <- ifelse(
    i > 1,
    str_rev(tiles$e[tiles$tile_id == placed_tile_mat[i - 1, j]]),
    this_tile$w
  )
  
  verbose(glue::glue("Required n:{required_north}; w:{required_west}"))
  verbose(glue::glue("Actual n:{this_tile$n}; w:{this_tile$w}"))

  if (this_tile$n != required_north || this_tile$w != required_west) {
    return(NA)
  }
  
  verbose(paste0("Placing ", to_place_tile_id, " in ", i, ", ", j, "."))
  
  placed_tile_mat[i, j] <- to_place_tile_id
  if (i == width && j == width) {
    return(placed_tile_mat)
  }
  
  # Remove tile
  # tiles <- tiles %>% filter(tile_id_original != this_tile$tile_id_original)
  remaining_tiles <- tiles %>% filter(!(tile_id_original %in% parse_number(placed_tile_mat)))
  i <- i + 1
  if (i > width) {
    i <- 1
    j <- j + 1
  }
  
  # Iterate through remaining tiles and place_tile
  for (new_tile_id in remaining_tiles$tile_id) {
    result <- place_tile(placed_tile_mat, tiles, new_tile_id, i, j, width, debug)
    if (!is.na(result)) {
      return(result)
    }
  }
  return(NA)
}

solve <- function(tiles_exploded, debug = FALSE) {
  width <- tiles_exploded %>% pull(tile_id_original) %>% unique() %>% length() %>% sqrt()

  for (to_place_tile_id in tiles_exploded$tile_id) {
    result <- place_tile(
      matrix(NA, nrow = width, ncol = width),
      tiles_exploded,
      to_place_tile_id,
      i = 1,
      j = 1,
      width = width,
      debug = debug
    )
    if (!is.na(result)) {
      return(result)
    }
  }
  NA
}

# COMMAND ----------

# Takes 3.6 minutes
result <- solve(tiles_exploded)
result

# COMMAND ----------

corners <- c(
  result[1, 1],
  result[1, ncol(result)],
  result[nrow(result), ncol(result)],
  result[nrow(result), 1]
) %>%
  parse_number()
corners

# COMMAND ----------

answer <- reduce(corners, `*`)
format(answer, scientific = FALSE)

# COMMAND ----------

# MAGIC %md ## Part 2

# COMMAND ----------

rotate <- function(x) apply(t(x), 2, rev)
# rotate <- function(x) t(apply(x, 2, rev))

get_trimmed_tile <- function(original_tile_id, orientation, is_inverted) {
  m <-
    tiles_m %>%
    keep(~.$tile_id == original_tile_id) %>%
    `[[`(1) %>%
    `[[`("m")
  
  if (is_inverted) {
    m <- t(apply(m, 1, rev))
  }

  if (orientation > 1) {
    for (i in seq(from = 2, to = orientation, by = 1)) {
      m <- rotate(m)
    }
  }
  
  m[c(-1, -nrow(m)), c(-1, -ncol(m))]
}

# COMMAND ----------

coords <-
  cbind(as.character(result), which(result == result, arr.ind = TRUE)) %>%
  as_tibble() %>%
  transmute(
    tile_id = V1,
    x = as.integer(row),
    y = as.integer(col)
  )
coords

# COMMAND ----------

map_tiles <-
  coords %>%
  mutate(
    s = asplit(str_match(tile_id, "(\\d+)_(\\d)(i?)"), 1),
    original_tile_id = map_chr(s, 2),
    orientation = map_int(s, ~as.integer(.[3])),
    is_inverted = map_lgl(s, ~.[4] == "i")
  ) %>%
  select(-s) %>%
  mutate(m = pmap(lst(original_tile_id, orientation, is_inverted), get_trimmed_tile))
map_tiles

# COMMAND ----------

img_m <-
  map_tiles %>%
  group_by(y) %>%
  arrange(x) %>%
  summarise(m = list(reduce(m, cbind))) %>%
  ungroup() %>%
  arrange(y) %>%
  summarise(m = list(reduce(m, rbind))) %>%
  pull(m) %>%
  first()

# COMMAND ----------

print_mat <- function(mat) {
  apply(mat, 1, paste0, collapse = "") %>%
  paste0(collapse = "\n") %>%
  cat()
}
print_mat(img_m)

# COMMAND ----------



# COMMAND ----------

monster <- "                  # 
#    ##    ##    ###
 #  #  #  #  #  #   " %>%
  read_lines() %>%
  str_split("") %>%
  simplify2array() %>%
  t()
monster

# COMMAND ----------

monster_hashes <- sum(monster == "#")
monster_hashes

# COMMAND ----------

show_monster <- function(mat, monster) {
  if (sum(monster == mat) == sum(monster == "#")) {
    mat[monster == "#"] <- "O"
  }
  
  mat
}

# COMMAND ----------

show_monster(ifelse(monster == " ", ".", "#"), monster)

# COMMAND ----------

1:(1 + ncol(monster) - 1)

# COMMAND ----------

1:(1 + ncol(monster) - 1)

# COMMAND ----------

monster[1:(1 + ncol(monster) - 1), 1:(1 + nrow(monster) - 1)]

# COMMAND ----------

result <- img_m
for (x in seq_len(ncol(result) - ncol(monster) + 1)) {
  for (y in seq_len(nrow(result) - nrow(monster) + 1)) {
    result[y:(y + nrow(monster) - 1), x:(x + ncol(monster) - 1)] <- show_monster(result[y:(y + nrow(monster) - 1), x:(x + ncol(monster) - 1)], monster)
  }
}
result

# COMMAND ----------

monster_mats <- list(
  monster,
  rotate(monster),
  rotate(rotate(monster)),
  rotate(rotate(rotate(monster))),
  
  t(apply(monster, 1, rev)),
  rotate(t(apply(monster, 1, rev))),
  rotate(rotate(t(apply(monster, 1, rev)))),
  rotate(rotate(rotate(t(apply(monster, 1, rev)))))
)

# COMMAND ----------

result <- img_m
for (monster_mat in monster_mats) {
  for (x in seq_len(ncol(result) - ncol(monster_mat) + 1)) {
    for (y in seq_len(nrow(result) - nrow(monster_mat) + 1)) {
      result[y:(y + nrow(monster_mat) - 1), x:(x + ncol(monster_mat) - 1)] <- show_monster(result[y:(y + nrow(monster_mat) - 1), x:(x + ncol(monster_mat) - 1)], monster_mat)
    }
  }
  result
}
result

# COMMAND ----------

sum(result == "#")

# COMMAND ----------

# MAGIC %md ## Scratch

# COMMAND ----------

  map_tiles %>%
  group_by(y) %>%
  arrange(y, x)

# COMMAND ----------

  map_tiles %>%
  group_by(y) %>%
  arrange(x) %>%
  summarise(m = list(reduce(m, cbind))) %>%
  filter(y == 1) %>%
  pull(m) %>%
  first()

# COMMAND ----------

map_tiles %>% filter(y == 1, x %in% c(1, 2))

# COMMAND ----------

map_tiles %>% filter(y == 1, x %in% c(1, 2)) %>% summarise(m = list(reduce(m, cbind))) %>% pull(m)

# COMMAND ----------

map_tiles %>%
  group_by(y) %>%
  arrange(x) %>%
  summarise(m = list(reduce(m, cbind))) %>%
  filter(y == 1) %>%
  pull(m) %>%
  first()

# COMMAND ----------

img_m

# COMMAND ----------

apply(img_m, 1, paste0, collapse = "") %>% paste0(collapse = "\n") %>% cat()

# COMMAND ----------

.#.###.### #.#...#### .#....#.## .####.#..# ...#..#.#. .####...#. ..#.####.. .###.###.# .###...#.. ....#...#. .#..#...## #.....#.##
..##..##.# .#.###...# .......... ...#...### ......#... #.......## ....#..### ###.##.#.# #####.#... #....#.#.# #....###.. .........#
.#..#.##.# ......#..# ##.#...... .......##. #....#.### #........# ..##..#..# #..#.##..# #.###..#.# ...#.#.#.. ..#..##.## #.........
#......#.# #..#...... ....#....# .......##. ..#....#.. #..#..#..# ....#.#... .###.###.# ..##....#. ...#..#... ..##...#.. ....##...#
..#......# .#.##.###. #...#..##. #..#..#..# ..#..##..# ...#.#.... .....##.## #.#....#.. #....#.#.. .###...... ....#.#... .##.......
...#..##.. #.....##.. ##...#.#.# ##...#.... ........#. ...####..# .#..###.## #......#.. .##...###. #........# #...##.#.. .#...#.##.
...#.#...# ####..#.## .......#.# ....##.... #..#.....# .....#..#. ##..##..## ##......#. ..#.###### ..##.#...# #..##.#..# #......##.
#..#..#..# .#......#. .#.#.#.... ##........ ...#..#..# ..#.#...## #.#....### ##..#.##.# .....##..# #...#..... ...##..... .#.....#.#
.......... #..#.....# ..#.##...# ..#..##### .......#.# ...#..#... #......#.. ..#....... #.#......# ###....... .#....#..# ###...##.#
...##.#.#. ##.#.#..## .##.#.##.# ..#..##... ...###.##. ...#.####. .##..###.# ##..###.#. ...##.#..# ....#.##.. .#..#..### #....###.#

# COMMAND ----------

.#.#.##... ##..#.#.## #.##.#.##..####.#..#...#..#.#..####.#.....#.####...###.###.##..#.##.......#...#..#..#...###.....#.##
.......... #.....#..# #...##.#.....#...###......#......#..#.......#..######.##.#.##......#.##....#.#.##....###...........#
#..#..#..# .#......#. ....#.#.#........##.#....#.#####...#.#....##..#..##..#.##..##..##........#.#.#....#..##.###.........
#...#.#... ##.#..#### #.#..............##...#....#...#..#.........#.#....###.###.#######.#.....#..#.....##...#......##...#
..##..#... ..##.....# #.#.#...###..#..#..#..#..##..##..####........##.###.#....#...###...##..###..........#.#....##.......
#......#.. .###.##.#. .##..#...###...#............#.....#.#....#..###.###......#....#.#....##........##...##.#...#...#.##.
#.#......# ......#..# #....#........##....#..#.....##..#..#..###..##..####......#..#....##....##.#...##..##.#..##......##.
#.##.#..#. #..#...... ......#.####...........#..#..##........##.#....#####..#.##.##.#..###.##...#........##......#.....#.#
#.##..##.. #...###.#. ............#..#####.......#.###.......##......#....#..........#.########........#....#..####...##.#
###.###.#. ####...#.# ##.#....#...#..##......###.##..#...####..##..###.###..###.#...#...###.....#.##...#..#..####....###.#

# COMMAND ----------

get_trimmed_tile("3539", 1, FALSE)

# COMMAND ----------

get_trimmed_tile("3539", 1, TRUE)

# COMMAND ----------

get_trimmed_tile("3539", 2, FALSE)

# COMMAND ----------

m <-
  tiles_m %>%
  keep(~.$tile_id == "3539") %>%
  `[[`(1) %>%
  `[[`("m")
m

# COMMAND ----------

m[c(-1, -nrow(m)), c(-1, -ncol(m))]

# COMMAND ----------

asplit(str_match(coords$tile_id, "(\\d+)_(\\d)(i?)"), 1)

# COMMAND ----------

str_match(coords$tile_id, "(\\d+)_(\\d)(i?)")

# COMMAND ----------

current_tile_id <- "3671_2i"

# COMMAND ----------

# tile_id, x, y

# COMMAND ----------

str_match(current_tile_id, "(\\d+)_(\\d)(i?)")