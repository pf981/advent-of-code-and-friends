# Databricks notebook source
# MAGIC %md https://adventofcode.com/2020/day/20

# COMMAND ----------

# MAGIC %md <article class="day-desc"><h2>--- Day 20: Jurassic Jigsaw ---</h2><p>The high-speed train leaves the forest and quickly carries you south. You can even see a desert in the distance! Since you have some spare time, you <span title="Just in case. Maybe they missed something.">might as well</span> see if there was anything interesting in the image the Mythical Information Bureau satellite captured.</p>
# MAGIC <p>After decoding the satellite messages, you discover that the data actually contains many small images created by the satellite's <em>camera array</em>. The camera array consists of many cameras; rather than produce a single square image, they produce many smaller square image <em>tiles</em> that need to be <em>reassembled back into a single image</em>.</p>
# MAGIC <p>Each camera in the camera array returns a single monochrome <em>image tile</em> with a random unique <em>ID number</em>.  The tiles (your puzzle input) arrived in a random order.</p>
# MAGIC <p>Worse yet, the camera array appears to be malfunctioning: each image tile has been <em>rotated and flipped to a random orientation</em>. Your first task is to reassemble the original image by orienting the tiles so they fit together.</p>
# MAGIC <p>To show how the tiles should be reassembled, each tile's image data includes a border that should line up exactly with its adjacent tiles. All tiles have this border, and the border lines up exactly when the tiles are both oriented correctly. Tiles at the edge of the image also have this border, but the outermost edges won't line up with any other tiles.</p>
# MAGIC <p>For example, suppose you have the following nine tiles:</p>
# MAGIC <pre><code>Tile 2311:
# MAGIC ..##.#..#.
# MAGIC ##..#.....
# MAGIC #...##..#.
# MAGIC ####.#...#
# MAGIC ##.##.###.
# MAGIC ##...#.###
# MAGIC .#.#.#..##
# MAGIC ..#....#..
# MAGIC ###...#.#.
# MAGIC ..###..###
# MAGIC 
# MAGIC Tile 1951:
# MAGIC #.##...##.
# MAGIC #.####...#
# MAGIC .....#..##
# MAGIC #...######
# MAGIC .##.#....#
# MAGIC .###.#####
# MAGIC ###.##.##.
# MAGIC .###....#.
# MAGIC ..#.#..#.#
# MAGIC #...##.#..
# MAGIC 
# MAGIC Tile 1171:
# MAGIC ####...##.
# MAGIC #..##.#..#
# MAGIC ##.#..#.#.
# MAGIC .###.####.
# MAGIC ..###.####
# MAGIC .##....##.
# MAGIC .#...####.
# MAGIC #.##.####.
# MAGIC ####..#...
# MAGIC .....##...
# MAGIC 
# MAGIC Tile 1427:
# MAGIC ###.##.#..
# MAGIC .#..#.##..
# MAGIC .#.##.#..#
# MAGIC #.#.#.##.#
# MAGIC ....#...##
# MAGIC ...##..##.
# MAGIC ...#.#####
# MAGIC .#.####.#.
# MAGIC ..#..###.#
# MAGIC ..##.#..#.
# MAGIC 
# MAGIC Tile 1489:
# MAGIC ##.#.#....
# MAGIC ..##...#..
# MAGIC .##..##...
# MAGIC ..#...#...
# MAGIC #####...#.
# MAGIC #..#.#.#.#
# MAGIC ...#.#.#..
# MAGIC ##.#...##.
# MAGIC ..##.##.##
# MAGIC ###.##.#..
# MAGIC 
# MAGIC Tile 2473:
# MAGIC #....####.
# MAGIC #..#.##...
# MAGIC #.##..#...
# MAGIC ######.#.#
# MAGIC .#...#.#.#
# MAGIC .#########
# MAGIC .###.#..#.
# MAGIC ########.#
# MAGIC ##...##.#.
# MAGIC ..###.#.#.
# MAGIC 
# MAGIC Tile 2971:
# MAGIC ..#.#....#
# MAGIC #...###...
# MAGIC #.#.###...
# MAGIC ##.##..#..
# MAGIC .#####..##
# MAGIC .#..####.#
# MAGIC #..#.#..#.
# MAGIC ..####.###
# MAGIC ..#.#.###.
# MAGIC ...#.#.#.#
# MAGIC 
# MAGIC Tile 2729:
# MAGIC ...#.#.#.#
# MAGIC ####.#....
# MAGIC ..#.#.....
# MAGIC ....#..#.#
# MAGIC .##..##.#.
# MAGIC .#.####...
# MAGIC ####.#.#..
# MAGIC ##.####...
# MAGIC ##..#.##..
# MAGIC #.##...##.
# MAGIC 
# MAGIC Tile 3079:
# MAGIC #.#.#####.
# MAGIC .#..######
# MAGIC ..#.......
# MAGIC ######....
# MAGIC ####.#..#.
# MAGIC .#...#.##.
# MAGIC #.#####.##
# MAGIC ..#.###...
# MAGIC ..#.......
# MAGIC ..#.###...
# MAGIC </code></pre>
# MAGIC <p>By rotating, flipping, and rearranging them, you can find a square arrangement that causes all adjacent borders to line up:</p>
# MAGIC <pre><code>#...##.#.. ..###..### #.#.#####.
# MAGIC ..#.#..#.# ###...#.#. .#..######
# MAGIC .###....#. ..#....#.. ..#.......
# MAGIC ###.##.##. .#.#.#..## ######....
# MAGIC .###.##### ##...#.### ####.#..#.
# MAGIC .##.#....# ##.##.###. .#...#.##.
# MAGIC #...###### ####.#...# #.#####.##
# MAGIC .....#..## #...##..#. ..#.###...
# MAGIC #.####...# ##..#..... ..#.......
# MAGIC #.##...##. ..##.#..#. ..#.###...
# MAGIC 
# MAGIC #.##...##. ..##.#..#. ..#.###...
# MAGIC ##..#.##.. ..#..###.# ##.##....#
# MAGIC ##.####... .#.####.#. ..#.###..#
# MAGIC ####.#.#.. ...#.##### ###.#..###
# MAGIC .#.####... ...##..##. .######.##
# MAGIC .##..##.#. ....#...## #.#.#.#...
# MAGIC ....#..#.# #.#.#.##.# #.###.###.
# MAGIC ..#.#..... .#.##.#..# #.###.##..
# MAGIC ####.#.... .#..#.##.. .######...
# MAGIC ...#.#.#.# ###.##.#.. .##...####
# MAGIC 
# MAGIC ...#.#.#.# ###.##.#.. .##...####
# MAGIC ..#.#.###. ..##.##.## #..#.##..#
# MAGIC ..####.### ##.#...##. .#.#..#.##
# MAGIC #..#.#..#. ...#.#.#.. .####.###.
# MAGIC .#..####.# #..#.#.#.# ####.###..
# MAGIC .#####..## #####...#. .##....##.
# MAGIC ##.##..#.. ..#...#... .####...#.
# MAGIC #.#.###... .##..##... .####.##.#
# MAGIC #...###... ..##...#.. ...#..####
# MAGIC ..#.#....# ##.#.#.... ...##.....
# MAGIC </code></pre>
# MAGIC <p>For reference, the IDs of the above tiles are:</p>
# MAGIC <pre><code><em>1951</em>    2311    <em>3079</em>
# MAGIC 2729    1427    2473
# MAGIC <em>2971</em>    1489    <em>1171</em>
# MAGIC </code></pre>
# MAGIC <p>To check that you've assembled the image correctly, multiply the IDs of the four corner tiles together. If you do this with the assembled tiles from the example above, you get <code>1951 * 3079 * 2971 * 1171</code> = <em><code>20899048083289</code></em>.</p>
# MAGIC <p>Assemble the tiles into an image. <em>What do you get if you multiply together the IDs of the four corner tiles?</em></p>
# MAGIC </article>

# COMMAND ----------

inp = '''Tile 1621:
.#.##...#.
#..#..#.#.
#.#..#..##
.....#..#.
.#..#...##
#....#...#
.#........
#.#.#....#
...#...#..
.#..#....#

Tile 3671:
..#.#.###.
#.##....##
#.........
##..#.#...
#..###....
..#.#....#
##..###..#
..#......#
.........#
......###.

Tile 2803:
#.#.#..#..
#.....#...
...##..###
#.#.....##
#...#..#.#
..#...##.#
..#...#..#
####.#..##
#..##....#
#..#.##.#.

Tile 1531:
####.#####
.###...###
##..#..#.#
##.#..#..#
#....#..##
##.#....#.
#.#.##....
....#..#..
#...#.....
##....#...

Tile 1811:
#.#...#..#
##....#.##
#...##.#..
#..##.....
.#.#.....#
##..#.....
##.#......
..#...##..
.#.##....#
##...##..#

Tile 2143:
##.###.#.#
#..##.##..
###.......
..##.#...#
#.......#.
#.#....##.
...#..####
..##...#.#
#.#..#.##.
#.#.#...##

Tile 2887:
.......##.
#..#..#..#
....#.....
...#..##..
..#.......
#...##..##
..#...##..
#.....#.##
##..#..##.
#...#.####

Tile 3511:
.#.##....#
#.#...##.#
#...##.###
....#.....
..#......#
.###.#..#.
#.........
#.#....###
.......#.#
#..#######

Tile 3911:
.#..#.###.
#...#.##..
.#..#...##
##.#.##.##
....#.#..#
...###....
.....#...#
...##..#..
###.#.#.#.
##.....#.#

Tile 3821:
#####..#..
##..#.....
....##.#.#
#....#....
#...##.#.#
#........#
####......
#.#.#....#
....######
..#...###.

Tile 3539:
#####.##..
#........#
####.#....
.##..#.#.#
#.....#...
#.#......#
##...###.#
.#..#.....
#.#.......
...#...#..

Tile 3251:
....#..##.
.###.#...#
#..#.....#
...#.....#
..#.......
.##..#...#
#.......##
#.....#...
....#..#.#
######.#.#

Tile 2677:
.#...#...#
...#.###..
......##..
#.##.##...
#.#...#.##
#..#####..
......##..
......##.#
#..#..#...
..##.####.

Tile 3011:
#.#..#..##
#.###..#..
#..#..##..
#.#..#...#
##...#####
....#..###
.#..#..#.#
..#...#..#
##.##..#.#
.#.##.....

Tile 1489:
#...##.###
#.#..#....
#.....#..#
##..#.....
...#....##
.##.##.#.#
#.#......#
#........#
....#.....
##.#.#####

Tile 3769:
.....####.
##....####
###....#.#
.##..#.#.#
..........
##....####
#...#..#..
...#.....#
##.#.....#
#...##.###

Tile 2293:
.#..#.#...
####......
##...#....
###.#.#...
.##.##...#
......#.#.
##.....#..
#..#.##.##
.##....##.
.#.....#..

Tile 3947:
.#.#...##.
..........
..#...##.#
..###..#.#
##...#.###
.#..#..#..
#.#....#..
....#.#..#
.#....####
######..#.

Tile 1223:
#..#####.#
###..#..##
##.###....
...##.#...
..#.##.#..
##.###...#
...#..#.##
...#..#...
.#....#..#
#..####...

Tile 3331:
#.....##..
##..###.#.
.##.#...#.
.##..#.#..
#......#..
...#.....#
###.#.#...
.##......#
#..#......
...#...###

Tile 3691:
#..#..#.##
......#..#
#.#..##..#
###.......
#.#....##.
##.#..##..
#......#..
..#.......
...#.#..#.
#..#......

Tile 1289:
#.......#.
##.##....#
####......
.#..#.#..#
#.#.#..###
#..#......
##.#####..
.#........
##.##....#
##.#######

Tile 2857:
.#.#..#.##
.....#.#..
#..#...#..
.##...#..#
##..#..#.#
#..#..#..#
...#......
#.#.#.....
##...#....
....#.##..

Tile 3559:
#.##..##..
..#.##.###
##..#....#
#.#..#..#.
##.####..#
.....#...#
#....#....
##..#.##..
#..#.....#
###.##..##

Tile 2633:
...#.#..##
##.......#
#...##..#.
#.#....#.#
.........#
...#.....#
.#.##....#
...#..#...
#.#.##....
..#..##...

Tile 1973:
#.#.....#.
#.......#.
#....#....
.#.#...##.
.........#
#.......#.
...#.##..#
.##...#...
##..#..#..
####..##.#

Tile 1373:
#####.#..#
##.##..###
#.####...#
..###.#...
....##...#
#...#....#
##.#....##
.......#..
##.#.##.#.
#.###.##.#

Tile 1759:
.#.....##.
#.#..#...#
....###..#
........##
....#.....
.....#..#.
#...#....#
.#..#...#.
...#.#.#..
##...#..##

Tile 1213:
#....###.#
###...##.#
.#.....#.#
#......##.
.#...#.##.
.##.......
....##...#
#.........
.........#
#.....#.##

Tile 2341:
#.....#.#.
...##.#..#
.....##..#
......##.#
#...#....#
..#...###.
..##.#.#.#
.#.#....##
.#.....###
.#.#...##.

Tile 3547:
####.#.#.#
...###...#
#..#.##...
##..#.#...
#....#.#.#
.#.......#
.#.#......
###.....#.
#.#....###
.#.##.#...

Tile 2003:
#####.####
...#..#..#
.#.......#
#.#.#...##
.#.#.#..#.
#......#..
...#..#...
.#...#.#..
#........#
####.###..

Tile 2861:
#..##.##..
..#.#....#
....##.#..
##........
#.........
##.....#.#
##.....##.
####.....#
###..#####
.........#

Tile 3697:
#..##.####
.....#....
#.#.#.#.#.
#.##...###
..##.....#
.#.......#
.##.......
#.#..#...#
.#.###.#..
####.####.

Tile 3929:
.#.##..#.#
##.#....##
....#.#..#
....#.#.#.
##........
...#..#...
###....#.#
#........#
.###.##.##
###..#####

Tile 3527:
#.#.#...#.
####.#....
......#...
.##......#
.#......##
.##.#.#.##
#..#......
#.....#...
.#........
..#..####.

Tile 1777:
.#..#...##
#....###..
..#..##.##
..##...#..
....#.#...
#...##.#..
#..##.#..#
...##.....
.#....#..#
.#..#..###

Tile 1543:
......#...
.#...##...
#...#..#.#
..........
#..##....#
..#.#...##
...#.####.
##....#...
...#..####
.#.#..####

Tile 2063:
##....#...
#.....#...
###.##...#
......#..#
...##..#..
###.#.....
##.....##.
#..#.##...
##.###..##
#....###..

Tile 1181:
#.##...###
####.#....
.........#
####..##.#
.....#..#.
.......#..
..###....#
##..##....
#.#...#..#
.#.#.#...#

Tile 3491:
#...###.##
..##..#.##
.......##.
..........
.....#..#.
#..#......
##....#.#.
...##...#.
..###.....
..#.##..#.

Tile 1873:
...#.....#
...#.#..#.
##.#......
.#...#.###
#.#.#..#..
.....###.#
#..#..#...
....#.....
.....#.#.#
######...#

Tile 2579:
.####...#.
#..#..#..#
.....#...#
#.#..#...#
#.....##..
......#..#
#......##.
.#...##...
.#...##...
.##.####..

Tile 1481:
.#.#.#####
..#.#.##..
.###...#.#
...##.....
..#.#.#.#.
.#.......#
##.#....#.
#.#...#...
.###..#...
......##.#

Tile 2417:
.#..#..#.#
.#.#.....#
.###..##.#
#.#.#.....
#....#.###
..#..#....
#....#.#..
####....##
..#.#...##
....######

Tile 3581:
..##.....#
.....##..#
#.........
#....##..#
#..#....#.
#.....#..#
.#..#.#.#.
...#......
.....##..#
#.........

Tile 3593:
#.##.###..
###.....##
##.#....#.
###.#....#
###....#.#
#.#..#..##
......#.##
...#....#.
.#...#..#.
..#####..#

Tile 3167:
#...#.#.#.
......#.##
##.##.#.##
#...#.##.#
....#...#.
..#....##.
...#...##.
...##..#..
....#.##.#
##.#....#.

Tile 1439:
...##..###
#.#......#
..#..###.#
....#.#...
#.........
......#..#
..#.#.#..#
##.#.#....
..#...#..#
#.###.#...

Tile 1249:
..#.##...#
#.#......#
.......#..
##.#.#.#.#
.#..#..#..
..#.#..#.#
.....##.#.
#........#
..#..##.##
..#..#####

Tile 2687:
##...##...
###.###.#.
#...###..#
.#.......#
....#.#...
.....#####
##.#####..
#....#....
..#.####.#
##....#.#.

Tile 2693:
..#..#..#.
....#..###
....##....
.#.##.....
.#..###...
..##.#....
#.........
....##.##.
..#..#....
.#.#......

Tile 1741:
.#.###..##
......####
#.......##
#.#......#
##..#...#.
##.....#.#
#..#......
..##.#..##
#..#......
#.#..###.#

Tile 3413:
...####.#.
.#..#.##..
#....#.##.
##.#.....#
##.###..##
.......###
.#....###.
#....##..#
##.####..#
....#.###.

Tile 3191:
.....####.
##.##..#..
.##.#.##.#
.......###
....####..
.#.#..#.#.
...#...#..
##..#..#.#
...#..#...
..##..#.#.

Tile 2897:
#.#######.
...#....#.
#.....##.#
###.#...#.
##.#####.#
..#.##..##
#.##......
##.#.##..#
#.#....#..
#.##.#.###

Tile 2017:
##.##...##
#...#.##..
#..#.#...#
.##.......
##.......#
##..#.#..#
##.#.#.#.#
..........
..........
..######.#

Tile 2939:
#...##.##.
.....#.##.
....#.#...
#.#......#
.#.....#.#
.........#
###.....##
......#..#
#..#..##..
.##..#.##.

Tile 1753:
#...#.#.##
.#...#...#
###..#.###
#..##....#
#..#......
#.##...#..
..#...#...
#..#......
.#.......#
....#.#.##

Tile 3229:
#..####.#.
#.....#..#
......##..
#.#...##.#
#...#...##
#.#....#.#
.#..##..#.
#..#.....#
#..##.....
.#.#.#..##

Tile 1367:
####.....#
...#.##...
...#...#..
.#.###..#.
.........#
.#........
..........
.#...###.#
##........
...##..#.#

Tile 2851:
..#.#...##
#.....##.#
.##.#..#.#
#...###..#
###...#...
....#..#.#
..#.......
#.....#...
...#.#...#
.###..#..#

Tile 2357:
....##.#.#
###...#.##
####..##.#
#.####...#
#...##...#
#.#......#
#..##.#.#.
#.#....#.#
.###...#..
####..#.##

Tile 1697:
#..#.#.##.
.......#..
...##....#
##........
....#....#
##.#.....#
.##......#
#....#..#.
##.##...##
#....#...#

Tile 1571:
#.###...#.
##..#..#..
.........#
...#.#.#..
#........#
#..##.#...
##...##.#.
..........
....#.#...
.##.....#.

Tile 3323:
#.#.#..###
#...#...##
.......#.#
#.##......
..#.#..##.
#.......#.
....####.#
....##...#
..##....##
######.###

Tile 3461:
#....##.#.
....#.....
#......##.
##.....##.
#..#...##.
.#.......#
##.#......
..........
.....#..##
.....#.###

Tile 2719:
.#.#.#....
..#..#.##.
..##...###
..#..#...#
##.......#
.#........
.##..#....
..##..#...
..#....#..
.#.#.#..#.

Tile 3359:
.###...#.#
.....###.#
#..####.#.
.....##..#
..#.#...#.
#.#..###..
..#....#.#
....#.#..#
.....#..#.
#.###.#..#

Tile 3803:
.####.#..#
...#...###
.......##.
.......##.
#..#..#..#
##...#....
....##....
##........
..#..#####
..#..##...

Tile 3019:
##..###.#.
..#.......
##..#.##.#
##......#.
#......#..
#.#....#..
.###.###.#
#..#.##..#
###.##.#.#
.###.###.#

Tile 2791:
......#.#.
#....#....
##...#####
....##....
#.....##.#
..##......
#.#...#..#
...##...#.
..##....#.
##.##..#..

Tile 3881:
#....##..#
...#..#..#
.###..#..#
...#....##
#...#..#.#
#.#.#..#.#
#..##.....
...#......
#.#....#..
.#..##.###

Tile 2087:
.#..#.#...
###....###
.###..#.##
........##
###.##..##
...#...#.#
#...#....#
##..#....#
#..####.#.
##..#####.

Tile 1789:
######.#..
........#.
..#...##.#
.#.......#
.#...#....
#..#.#..##
#####.#..#
#...###..#
.#.#....##
####.##.#.

Tile 2539:
#.###.#..#
..#..#...#
##.##.#...
#.....##..
#..##..#..
..###.##.#
#..###...#
.###.#.#..
#...#.....
..###.##..

Tile 2111:
####..###.
#....###..
..#.....##
#....##.##
#.....#...
#..#.#....
...#..####
##..##..#.
##.....#.#
#.#...#.#.

Tile 1433:
#.....#..#
.#.###.#.#
.#...#.#.#
.......###
#..##.#...
.#...##.#.
#..#....##
#......#..
....#..#.#
..#.#..##.

Tile 1667:
..##......
#..#....#.
.##.#..#.#
.....#....
#.#.##..#.
...##.....
..#.#....#
#.#..#...#
...#...##.
....#....#

Tile 2389:
.#.#...#..
.#.......#
.....#....
#...###..#
..........
.#........
.#.###.#.#
#....#..#.
..#......#
##...#...#

Tile 1069:
...###..##
...#.....#
##......##
....##....
..#..##..#
##..#..#.#
##.#.#.#.#
.#..###..#
#.#.......
.#.#.#....

Tile 1103:
..###.##..
...##..#.#
#....##..#
....#..#.#
#....#.#..
###....###
..#...##..
..##.....#
#........#
.####..#..

Tile 3761:
....#.##..
###.......
#...#.....
..##.#...#
#........#
.###......
...#..#...
...#.#.#..
#....#.#.#
....#...#.

Tile 2473:
........##
.#.#..#...
.#........
.####.#.##
##..##...#
##.....#..
###.#..#.#
..........
.#.#..##.#
..#....#.#

Tile 1987:
...#..#.#.
......#...
#....#.###
..#....#..
..#..##..#
........#.
#..#.....#
...#..#..#
.......#.#
...###.##.

Tile 1187:
..#.#.#..#
##.#...##.
#......#.#
....#....#
..##...#.#
#..#..#.##
..........
..##...#.#
...####..#
.#.#.#####

Tile 2699:
###.#.##.#
.#.#####.#
.#..#..#..
.###....##
..#..##..#
.....#...#
..........
#...##...#
#.........
##..#..#.#

Tile 3643:
..##...#..
#..#..#.##
#.###.####
..##..##..
......#...
##.##..#..
...#.##.##
....#..#.#
##..#....#
#....#...#

Tile 3463:
..###.##.#
......##.#
#........#
......##.#
##.......#
##..#..#.#
##.......#
##......#.
##.#.##...
.###..#.##

Tile 1117:
#.#.##....
..#..#.###
.#..#.....
...#.#....
........#.
##.###...#
..#..#.#.#
....#..#..
..#.#....#
..#.#..#..

Tile 1163:
.##.##..##
....#..#..
##..#..#..
#..#.....#
#..#.....#
..#.##....
...#.#....
..###..#.#
...#...#.#
###.######

Tile 3557:
#.#....#..
....####.#
.#....####
..#...###.
#......#..
.......#..
##....#...
##.....#..
...#..#.#.
...###.#..

Tile 2467:
.####....#
.#.#..##.#
####......
......#.#.
#.#....#.#
##.....#..
..#....#.#
..#.##...#
.#.....###
#...##.##.

Tile 1471:
.###..#.##
##.#...##.
.#...#....
....##..#.
........#.
##....##.#
###..##.#.
#....###.#
##.....##.
#..#..##.#

Tile 3931:
#....#..##
#...#..#..
.#..######
#.###...#.
....#.##.#
#.#...####
#....#..#.
....##.#..
#..#..####
#.#.#.....

Tile 2029:
##.#.#####
#.#......#
#...##...#
#...#.....
#..##.....
#.....##.#
....##....
..##.#.###
###.#.###.
..####.##.

Tile 1913:
#..###.###
.......###
.#..#.####
.#..#.#...
..#.......
.#....###.
.###..#.#.
#....#..#.
#.#..#.#..
.#..#.#.#.

Tile 2213:
..#.##.###
......###.
..#..#...#
#..#..#.##
#....###..
...#....#.
#.##.#..#.
##.#...#..
.##....###
####.#..#.

Tile 1511:
###.#...##
.##.....#.
.##...#..#
...##.##..
#.#..#.#.#
##...###.#
###..#.###
.##.##..#.
#......#..
###.....##

Tile 2243:
#..#.#...#
##...#....
.....#.#.#
....##..#.
#..######.
.#..#.##..
#.........
...#.##.#.
.#.......#
.##...#.##

Tile 3701:
...#######
#..#...##.
...####..#
..#..#...#
##........
#.....#..#
##..#.#...
##.#.##.#.
.##.......
###.#...##

Tile 3137:
.#.####...
#..#.#...#
.......#.#
#..#.....#
#.....#...
#...###.##
.###...#.#
##......##
#.#....#.#
##...####.

Tile 2437:
#...#..###
.#.#....#.
....#...#.
.......#.#
#.#...##.#
###..#...#
#.##..#...
....#.....
#.#.#.##..
.#.#.#.###

Tile 1009:
..#.#.#...
...#..##..
##...##..#
........##
##...###.#
#....#...#
..#..#...#
..####.###
#.........
####..#..#

Tile 2399:
..####.#..
###..#....
#..#..##..
...#.#....
##.##.....
##.###..#.
##..##..##
###....#.#
..#......#
#.###..##.

Tile 2843:
.....#....
......#...
.##.#....#
..#....#..
.##.....##
.#...##.#.
####..##..
.##....##.
....##...#
#..###...#

Tile 1193:
##.....###
.......#..
.#...#.#..
#.#...#.##
..#.....##
.#.....#..
#...#....#
##.#..#.#.
##.....#.#
#..#.....#

Tile 1951:
###......#
..........
..........
#####.....
#.##..#...
.........#
##.##.....
#.#..#.##.
.#...#...#
..#.###...

Tile 1879:
#...#.....
.#.......#
###.......
#####.....
#..#.#....
...###.##.
#.......#.
#.#......#
.#..##....
..#.##.###

Tile 3469:
..####...#
#...#...#.
......###.
........#.
####.....#
#...#...#.
...#....##
#..#..#..#
..#...##.#
#####..#.#

Tile 2161:
####.####.
###...#.##
.##...#...
#..#...#..
##...##.#.
#.........
#...##...#
....#.#..#
..#.##..##
#.......##

Tile 2083:
##.##.#..#
#.##.#..#.
...#.....#
##.#.##.#.
.....#..#.
#.......#.
...###.#.#
....##...#
#.##.#...#
##.#...###

Tile 2089:
#.#.###.#.
#..##.....
.....#...#
#.........
.##...####
#...##...#
.#.......#
....#...##
#..##....#
.....##.#.

Tile 1051:
#.....##.#
.....##.#.
#...#....#
.#.#......
........#.
.......#..
##....#.##
#.......##
#........#
####.##.#.

Tile 3347:
....##.#..
#.#.#..#.#
##........
..#....#..
##...##...
.##.#.....
#........#
#..###....
.....#...#
##.##.#..#

Tile 2927:
#.##......
...#..#.##
.#.#.#.##.
..........
##....#...
##.#...#..
....##.##.
#....#.#..
..#.....#.
##.###.#..

Tile 1301:
#..##.#.#.
#.#......#
..#...#..#
##....#..#
#.........
.......#.#
....##.#..
#..#.###..
..#.######
...###.###

Tile 2459:
#..###....
...###.###
##........
##..#..#..
##.#.##.##
#.##.#..#.
#..##..##.
.#...##..#
#........#
..#.######

Tile 1583:
.#.#..#..#
#.#.#....#
.##.......
.........#
#....#....
##...###.#
#.#.......
.........#
#...#....#
#.###..#.#

Tile 3533:
.#.##.#..#
.#.......#
........#.
.#...#...#
#.........
.......#.#
...#...#..
##..#..#.#
...#.###..
.###..####

Tile 1993:
#.####..#.
..##.#.#.#
.#.#......
.#........
..#.......
#.##..#..#
##..#.....
.#.##..#..
........#.
.#.#.###.#

Tile 3853:
..#.####.#
##....##.#
..#......#
....#.....
.....#.##.
......#..#
..#..#.#.#
##....#...
###.#..##.
##...#.#.#

Tile 2113:
#..#.#.#.#
#.....#.##
#.....#..#
.##....#.#
##.#.#####
#..#......
...#...#..
...#.#..##
.......##.
..##....##

Tile 3319:
####.#..##
##....#.#.
#.......#.
......#..#
####...##.
..........
##.....#..
..#..#..##
#...#.....
.##..#...#

Tile 3847:
...##..#.#
..#.##...#
...#..####
#..#.#.#..
#........#
#....##..#
#....#..##
.#.#.##.##
.####.....
#....##..#

Tile 1283:
..##..###.
##.......#
#.#.#.....
.#.#....#.
..#..#....
#...#.....
##.......#
.##.#...##
##.####...
##..#..###

Tile 2957:
#.####.#.#
#..#..##..
#..###...#
#.#..#.#..
#.......#.
#.#..#...#
######....
#.......##
#...#...#.
.##..#.##.

Tile 1097:
.###.#.###
#......##.
#........#
....#...#.
..##..#.#.
#....#..##
.###...##.
..##.#...#
#..#.####.
#.#.......

Tile 1399:
#.###..###
#...##.###
....#.#...
#...##.#..
..#...#..#
#...###...
.......#..
..#.#.#...
...##...#.
...##..##.

Tile 1451:
#.#...#.#.
#........#
#.#....#.#
###.#.....
....##....
.##.#..#..
.#.####..#
..#..###.#
...#...#.#
#...##.#.#

Tile 1559:
#..#.#.###
......#...
.....#..##
#.........
##..#.....
...#...#..
##.#.#....
.....#.##.
#...#.#.#.
...#####..

Tile 3391:
#.#.#.#..#
##..#.....
.#...###..
......#..#
#.#.....#.
...#..#...
.#......#.
.......#..
.....#.#.#
#.#.#.##.#

Tile 2423:
#.#.#....#
#......#..
#.#.#.#.##
...#.#.#.#
....#.#.#.
.......#..
.##.....#.
.........#
#.#..#...#
...##..##.

Tile 2297:
.....#####
#..#......
#...#.....
##...#.#..
.......##.
#.......#.
###....###
..#.....#.
.....##...
##.##.###.

Tile 2011:
#######...
#.#...#.#.
...##..#..
...##..#.#
......#..#
#..#.....#
...#.#....
....#.#...
..#.###..#
#.#####.#.

Tile 1049:
#.#...#...
.......###
#..#.#..##
##.......#
.#.###...#
##....#...
...#.##...
........#.
...#..#.#.
##...##.##

Tile 3943:
..#...####
...#.##...
#.#.###...
.#...###.#
....#.##..
.##...#..#
####.....#
####.##.#.
##...#....
.##.#...#.

Tile 2039:
#####.#..#
#.#....###
.....#....
##.....#.#
.......#..
#......#..
..#...#..#
#.#...#...
..##...#..
##.#######

Tile 1297:
.#..##.###
#.....#..#
###..##..#
.##..#..##
...#......
#..#....##
..#......#
...##.#..#
....##....
#..###.#..

Tile 1597:
.#..#.##..
###......#
#...##...#
.#.#....##
...##.##..
#.###....#
###.#.....
..#....#.#
...##....#
###.##....

Tile 1319:
...#.##..#
#.#####...
..........
.#..#..#..
#...#.#.#.
.#.##..#..
###.......
#...#.##..
...#.....#
##.#####.#

Tile 2333:
#..##..##.
...#...#.#
..##.#....
#....#.##.
..##..##.#
..##..###.
...##.#..#
.....#.#.#
#......#.#
########..

Tile 1423:
#.##..##..
#.##.....#
#.#..##...
##.#####..
...#.#..#.
.#..#.#.#.
#.##....##
...###..##
#.#.#...#.
#..##.###.

Tile 1303:
.#########
##..#....#
..#.#.####
..........
#...#.....
#.#..#...#
###.#.....
.##.#....#
#.#.#..#..
##..##..#.
'''

# COMMAND ----------

import math

def get_connecting_tiles(tile_id, side_str, direction):
  return {tile_id2 for tile_id2, *_ in side_to_tiles[(side_str, direction)] if tile_id2 != tile_id}

def get_rotations(sides, tile_id, h_flipped, v_flipped):
  result = {}
  for rotation in range(4):
    result[(tile_id, rotation, h_flipped, v_flipped)] = sides
    sides = (sides[1], sides[2][::-1], sides[3], sides[0][::-1])
  return result


tiles = {}
for tile_string in inp.split('\n\n'):
  tile_id, *tile_definition = tile_string.splitlines()
  tile_id = int(tile_id[5:-1])
  tiles[tile_id] = tile_definition
  
up, right, down, left = range(4)

edges = {} # (tile_id, rotation, h_flipped, v_flipped): [side_string, ...]
for tile_id, tile_definition in tiles.items():
  sides = (
    tile_definition[0],
    ''.join(line[-1] for line in tile_definition),
    tile_definition[-1],
    ''.join(line[0] for line in tile_definition)
  )
  edges.update(get_rotations(sides, tile_id, False, False))
  
  # Flipped horizontally
  h_sides = (sides[0][::-1], sides[3], sides[2][::-1], sides[1])
  edges.update(get_rotations(h_sides, tile_id, True, False))
  
  # Flipped vertically
  v_sides = (sides[2], sides[1][::-1], sides[0], sides[3][::-1])
  edges.update(get_rotations(v_sides, tile_id, False, True))
  
  # Flipped both
  hv_sides = (v_sides[0][::-1], v_sides[3], v_sides[2][::-1], v_sides[1])
  edges.update(get_rotations(hv_sides, tile_id, True, True))

side_to_tiles = {} # (side_string, side): [(tile_id, rotation, h_flipped, v_flipped)]
for (tile_id, rotation, h_flipped, v_flipped), sides in edges.items():
  for side_id, s in enumerate(sides):
    side_to_tiles[(s, side_id)] = side_to_tiles.get((s, side_id), set())
    side_to_tiles[(s, side_id)].add((tile_id, rotation, h_flipped, v_flipped))
  
connectivity = {tile_id: 0 for tile_id in tiles} # tile_id: (max number of sides that could be connected at once)
for (tile_id, rotation, _, _), side_strs in edges.items():
  if rotation != 0:
    continue
  connections_up = get_connecting_tiles(tile_id, side_strs[up], down)
  connections_right = get_connecting_tiles(tile_id, side_strs[right], left)
  connections_down = get_connecting_tiles(tile_id, side_strs[down], up)
  connections_left = get_connecting_tiles(tile_id, side_strs[left], right)
  cur_connectivity = sum(bool(connections) for connections in [connections_up, connections_right, connections_down, connections_left])
  connectivity[tile_id] = max(connectivity[tile_id], cur_connectivity)

corner_tile_ids = {tile_id for tile_id, connections in connectivity.items() if connections == 2}
answer = math.prod(corner_tile_ids)
print(answer)

# COMMAND ----------

# MAGIC %md <article class="day-desc"><h2 id="part2">--- Part Two ---</h2><p>Now, you're ready to <em>check the image for sea monsters</em>.</p>
# MAGIC <p>The borders of each tile are not part of the actual image; start by removing them.</p>
# MAGIC <p>In the example above, the tiles become:</p>
# MAGIC <pre><code>.#.#..#. ##...#.# #..#####
# MAGIC ###....# .#....#. .#......
# MAGIC ##.##.## #.#.#..# #####...
# MAGIC ###.#### #...#.## ###.#..#
# MAGIC ##.#.... #.##.### #...#.##
# MAGIC ...##### ###.#... .#####.#
# MAGIC ....#..# ...##..# .#.###..
# MAGIC .####... #..#.... .#......
# MAGIC 
# MAGIC #..#.##. .#..###. #.##....
# MAGIC #.####.. #.####.# .#.###..
# MAGIC ###.#.#. ..#.#### ##.#..##
# MAGIC #.####.. ..##..## ######.#
# MAGIC ##..##.# ...#...# .#.#.#..
# MAGIC ...#..#. .#.#.##. .###.###
# MAGIC .#.#.... #.##.#.. .###.##.
# MAGIC ###.#... #..#.##. ######..
# MAGIC 
# MAGIC .#.#.### .##.##.# ..#.##..
# MAGIC .####.## #.#...## #.#..#.#
# MAGIC ..#.#..# ..#.#.#. ####.###
# MAGIC #..####. ..#.#.#. ###.###.
# MAGIC #####..# ####...# ##....##
# MAGIC #.##..#. .#...#.. ####...#
# MAGIC .#.###.. ##..##.. ####.##.
# MAGIC ...###.. .##...#. ..#..###
# MAGIC </code></pre>
# MAGIC <p>Remove the gaps to form the actual image:</p>
# MAGIC <pre><code>.#.#..#.##...#.##..#####
# MAGIC ###....#.#....#..#......
# MAGIC ##.##.###.#.#..######...
# MAGIC ###.#####...#.#####.#..#
# MAGIC ##.#....#.##.####...#.##
# MAGIC ...########.#....#####.#
# MAGIC ....#..#...##..#.#.###..
# MAGIC .####...#..#.....#......
# MAGIC #..#.##..#..###.#.##....
# MAGIC #.####..#.####.#.#.###..
# MAGIC ###.#.#...#.######.#..##
# MAGIC #.####....##..########.#
# MAGIC ##..##.#...#...#.#.#.#..
# MAGIC ...#..#..#.#.##..###.###
# MAGIC .#.#....#.##.#...###.##.
# MAGIC ###.#...#..#.##.######..
# MAGIC .#.#.###.##.##.#..#.##..
# MAGIC .####.###.#...###.#..#.#
# MAGIC ..#.#..#..#.#.#.####.###
# MAGIC #..####...#.#.#.###.###.
# MAGIC #####..#####...###....##
# MAGIC #.##..#..#...#..####...#
# MAGIC .#.###..##..##..####.##.
# MAGIC ...###...##...#...#..###
# MAGIC </code></pre>
# MAGIC <p>Now, you're ready to search for sea monsters! Because your image is monochrome, a sea monster will look like this:</p>
# MAGIC <pre><code>                  # 
# MAGIC #    ##    ##    ###
# MAGIC  #  #  #  #  #  #   
# MAGIC </code></pre>
# MAGIC <p>When looking for this pattern in the image, <em>the spaces can be anything</em>; only the <code>#</code> need to match. Also, you might need to rotate or flip your image before it's oriented correctly to find sea monsters. In the above image, <em>after flipping and rotating it</em> to the appropriate orientation, there are <em>two</em> sea monsters (marked with <code><em>O</em></code>):</p>
# MAGIC <pre><code>.####...#####..#...###..
# MAGIC #####..#..#.#.####..#.#.
# MAGIC .#.#...#.###...#.##.<em>O</em>#..
# MAGIC #.<em>O</em>.##.<em>O</em><em>O</em>#.#.<em>O</em><em>O</em>.##.<em>O</em><em>O</em><em>O</em>##
# MAGIC ..#<em>O</em>.#<em>O</em>#.<em>O</em>##<em>O</em>..<em>O</em>.#<em>O</em>##.##
# MAGIC ...#.#..##.##...#..#..##
# MAGIC #.##.#..#.#..#..##.#.#..
# MAGIC .###.##.....#...###.#...
# MAGIC #.####.#.#....##.#..#.#.
# MAGIC ##...#..#....#..#...####
# MAGIC ..#.##...###..#.#####..#
# MAGIC ....#.##.#.#####....#...
# MAGIC ..##.##.###.....#.##..#.
# MAGIC #...#...###..####....##.
# MAGIC .#.##...#.##.#.#.###...#
# MAGIC #.###.#..####...##..#...
# MAGIC #.###...#.##...#.##<em>O</em>###.
# MAGIC .<em>O</em>##.#<em>O</em><em>O</em>.###<em>O</em><em>O</em>##..<em>O</em><em>O</em><em>O</em>##.
# MAGIC ..<em>O</em>#.<em>O</em>..<em>O</em>..<em>O</em>.#<em>O</em>##<em>O</em>##.###
# MAGIC #.#..##.########..#..##.
# MAGIC #.#####..#.#...##..#....
# MAGIC #....##..#.#########..##
# MAGIC #...#.....#..##...###.##
# MAGIC #..###....##.#...##.##.#
# MAGIC </code></pre>
# MAGIC <p>Determine how rough the waters are in the sea monsters' habitat by counting the number of <code>#</code> that are <em>not</em> part of a sea monster. In the above example, the habitat's water roughness is <em><code>273</code></em>.</p>
# MAGIC <p><em>How many <code>#</code> are not part of a sea monster?</em></p>
# MAGIC </article>

# COMMAND ----------

result = {}
def try_place(row, col, remaining_tile_ids, tiles_per_side):
  if row == tiles_per_side:
    return result

  # Constraints
  possibilities = set(edges)
  if row > 0:
    above_tile = result[(row - 1, col)]
    above_tile_side = (edges[above_tile][down], up)
    possibilities = possibilities.intersection(side_to_tiles[above_tile_side])
  if col > 0:
    left_tile = result[(row, col - 1)]
    left_tile_side = (edges[left_tile][right], left)
    possibilities = possibilities.intersection(side_to_tiles[left_tile_side])
  
  col2 = col + 1
  row2 = row
  if col2 == tiles_per_side:
    col2 = 0
    row2 += 1
  
  for tile_id, rotation, h_flipped, v_flipped in possibilities:
    if row in [0, tiles_per_side - 1] and col in [0, tiles_per_side - 1] and tile_id not in corner_tile_ids: # Corner
      continue

    if tile_id not in remaining_tile_ids:
      continue
    result[(row, col)] = (tile_id, rotation, h_flipped, v_flipped)
    if (complete := try_place(row2, col2, remaining_tile_ids - {tile_id}, tiles_per_side)):
      return complete
    
tiles_per_side = int(math.sqrt(len(tiles)))

arrangement = try_place(0, 0, frozenset(tiles), tiles_per_side)

# COMMAND ----------

def mutate(tile, rotation, h_flipped, v_flipped):
  if h_flipped:
    tile = [line[::-1] for line in tile]
  if v_flipped:
    tile = tile[::-1]
  for _ in range(rotation):
    tile = list(zip(*(line[::-1] for line in tile)))
  return tile


active = set()
for (row, col), (tile_id, rotation, h_flipped, v_flipped) in arrangement.items():
  tile = mutate(tiles[tile_id], rotation, h_flipped, v_flipped)
  for r in range(1, 9):
    for c in range(1, 9):
      if tile[r][c] == '#':
        active.add((8 * row + r - 1, 8 * col + c - 1))

target = '''                  # 
#    ##    ##    ###
 #  #  #  #  #  #   '''
targets = []
for rotation in range(4):
  for h_flipped in [True, False]:
    for v_flipped in [True, False]:
      grid = mutate(target.splitlines(), rotation, h_flipped, v_flipped)
      targets.append({(row, col) for row, line in enumerate(grid) for col, c in enumerate(line) if c == '#'})

monster = set()
for row in range(tiles_per_side * 8):
  for col in range(tiles_per_side * 8):
    for target in targets:
      offset_target = {(r + row, c + col) for r, c in target}
      if offset_target.issubset(active):
        monster.update(offset_target)

answer = len(active) - len(monster)
print(answer)
