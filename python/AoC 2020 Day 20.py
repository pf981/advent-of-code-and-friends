# Databricks notebook source
# MAGIC %md https://adventofcode.com/2020/day/20

# COMMAND ----------

# MAGIC %md <article class="day-desc"><h2>--- Day 20: Jurassic Jigsaw ---</h2><p>The high-speed train leaves the forest and quickly carries you south. You can even see a desert in the distance! Since you have some spare time, you <span title="Just in case. Maybe they missed something.">might as well</span> see if there was anything interesting in the image the Mythical Information Bureau satellite captured.</p>
# MAGIC <p>After decoding the satellite messages, you discover that the data actually contains many small images created by the satellite's <em>camera array</em>. The camera array consists of many cameras; rather than produce a single square image, they produce many smaller square image <em>tiles</em> that need to be <em>reassembled back into a single image</em>.</p>
# MAGIC <p>Each camera in the camera array returns a single monochrome <em>image tile</em> with a random unique <em>ID number</em>.  The tiles (your puzzle input) arrived in a random order.</p>
# MAGIC <p>Worse yet, the camera array appears to be malfunctioning: each image tile has been <em>rotated and flipped to a random orientation</em>. Your first task is to reassemble the original image by orienting the tiles so they fit together.</p>
# MAGIC <p>To show how the tiles should be reassembled, each tile's image data includes a border that should line up exactly with its adjacent tiles. All tiles have this border, and the border lines up exactly when the tiles are both oriented correctly. Tiles at the edge of the image also have this border, but the outermost edges won't line up with any other tiles.</p>
# MAGIC <p>For example, suppose you have the following nine tiles:</p>
# MAGIC <pre><code>Tile 2311:
# MAGIC ..##.#..#.
# MAGIC ##..#.....
# MAGIC #...##..#.
# MAGIC ####.#...#
# MAGIC ##.##.###.
# MAGIC ##...#.###
# MAGIC .#.#.#..##
# MAGIC ..#....#..
# MAGIC ###...#.#.
# MAGIC ..###..###
# MAGIC 
# MAGIC Tile 1951:
# MAGIC #.##...##.
# MAGIC #.####...#
# MAGIC .....#..##
# MAGIC #...######
# MAGIC .##.#....#
# MAGIC .###.#####
# MAGIC ###.##.##.
# MAGIC .###....#.
# MAGIC ..#.#..#.#
# MAGIC #...##.#..
# MAGIC 
# MAGIC Tile 1171:
# MAGIC ####...##.
# MAGIC #..##.#..#
# MAGIC ##.#..#.#.
# MAGIC .###.####.
# MAGIC ..###.####
# MAGIC .##....##.
# MAGIC .#...####.
# MAGIC #.##.####.
# MAGIC ####..#...
# MAGIC .....##...
# MAGIC 
# MAGIC Tile 1427:
# MAGIC ###.##.#..
# MAGIC .#..#.##..
# MAGIC .#.##.#..#
# MAGIC #.#.#.##.#
# MAGIC ....#...##
# MAGIC ...##..##.
# MAGIC ...#.#####
# MAGIC .#.####.#.
# MAGIC ..#..###.#
# MAGIC ..##.#..#.
# MAGIC 
# MAGIC Tile 1489:
# MAGIC ##.#.#....
# MAGIC ..##...#..
# MAGIC .##..##...
# MAGIC ..#...#...
# MAGIC #####...#.
# MAGIC #..#.#.#.#
# MAGIC ...#.#.#..
# MAGIC ##.#...##.
# MAGIC ..##.##.##
# MAGIC ###.##.#..
# MAGIC 
# MAGIC Tile 2473:
# MAGIC #....####.
# MAGIC #..#.##...
# MAGIC #.##..#...
# MAGIC ######.#.#
# MAGIC .#...#.#.#
# MAGIC .#########
# MAGIC .###.#..#.
# MAGIC ########.#
# MAGIC ##...##.#.
# MAGIC ..###.#.#.
# MAGIC 
# MAGIC Tile 2971:
# MAGIC ..#.#....#
# MAGIC #...###...
# MAGIC #.#.###...
# MAGIC ##.##..#..
# MAGIC .#####..##
# MAGIC .#..####.#
# MAGIC #..#.#..#.
# MAGIC ..####.###
# MAGIC ..#.#.###.
# MAGIC ...#.#.#.#
# MAGIC 
# MAGIC Tile 2729:
# MAGIC ...#.#.#.#
# MAGIC ####.#....
# MAGIC ..#.#.....
# MAGIC ....#..#.#
# MAGIC .##..##.#.
# MAGIC .#.####...
# MAGIC ####.#.#..
# MAGIC ##.####...
# MAGIC ##..#.##..
# MAGIC #.##...##.
# MAGIC 
# MAGIC Tile 3079:
# MAGIC #.#.#####.
# MAGIC .#..######
# MAGIC ..#.......
# MAGIC ######....
# MAGIC ####.#..#.
# MAGIC .#...#.##.
# MAGIC #.#####.##
# MAGIC ..#.###...
# MAGIC ..#.......
# MAGIC ..#.###...
# MAGIC </code></pre>
# MAGIC <p>By rotating, flipping, and rearranging them, you can find a square arrangement that causes all adjacent borders to line up:</p>
# MAGIC <pre><code>#...##.#.. ..###..### #.#.#####.
# MAGIC ..#.#..#.# ###...#.#. .#..######
# MAGIC .###....#. ..#....#.. ..#.......
# MAGIC ###.##.##. .#.#.#..## ######....
# MAGIC .###.##### ##...#.### ####.#..#.
# MAGIC .##.#....# ##.##.###. .#...#.##.
# MAGIC #...###### ####.#...# #.#####.##
# MAGIC .....#..## #...##..#. ..#.###...
# MAGIC #.####...# ##..#..... ..#.......
# MAGIC #.##...##. ..##.#..#. ..#.###...
# MAGIC 
# MAGIC #.##...##. ..##.#..#. ..#.###...
# MAGIC ##..#.##.. ..#..###.# ##.##....#
# MAGIC ##.####... .#.####.#. ..#.###..#
# MAGIC ####.#.#.. ...#.##### ###.#..###
# MAGIC .#.####... ...##..##. .######.##
# MAGIC .##..##.#. ....#...## #.#.#.#...
# MAGIC ....#..#.# #.#.#.##.# #.###.###.
# MAGIC ..#.#..... .#.##.#..# #.###.##..
# MAGIC ####.#.... .#..#.##.. .######...
# MAGIC ...#.#.#.# ###.##.#.. .##...####
# MAGIC 
# MAGIC ...#.#.#.# ###.##.#.. .##...####
# MAGIC ..#.#.###. ..##.##.## #..#.##..#
# MAGIC ..####.### ##.#...##. .#.#..#.##
# MAGIC #..#.#..#. ...#.#.#.. .####.###.
# MAGIC .#..####.# #..#.#.#.# ####.###..
# MAGIC .#####..## #####...#. .##....##.
# MAGIC ##.##..#.. ..#...#... .####...#.
# MAGIC #.#.###... .##..##... .####.##.#
# MAGIC #...###... ..##...#.. ...#..####
# MAGIC ..#.#....# ##.#.#.... ...##.....
# MAGIC </code></pre>
# MAGIC <p>For reference, the IDs of the above tiles are:</p>
# MAGIC <pre><code><em>1951</em>    2311    <em>3079</em>
# MAGIC 2729    1427    2473
# MAGIC <em>2971</em>    1489    <em>1171</em>
# MAGIC </code></pre>
# MAGIC <p>To check that you've assembled the image correctly, multiply the IDs of the four corner tiles together. If you do this with the assembled tiles from the example above, you get <code>1951 * 3079 * 2971 * 1171</code> = <em><code>20899048083289</code></em>.</p>
# MAGIC <p>Assemble the tiles into an image. <em>What do you get if you multiply together the IDs of the four corner tiles?</em></p>
# MAGIC </article>

# COMMAND ----------

inp = '''Tile 1621:
.#.##...#.
#..#..#.#.
#.#..#..##
.....#..#.
.#..#...##
#....#...#
.#........
#.#.#....#
...#...#..
.#..#....#

Tile 3671:
..#.#.###.
#.##....##
#.........
##..#.#...
#..###....
..#.#....#
##..###..#
..#......#
.........#
......###.

Tile 2803:
#.#.#..#..
#.....#...
...##..###
#.#.....##
#...#..#.#
..#...##.#
..#...#..#
####.#..##
#..##....#
#..#.##.#.

Tile 1531:
####.#####
.###...###
##..#..#.#
##.#..#..#
#....#..##
##.#....#.
#.#.##....
....#..#..
#...#.....
##....#...

Tile 1811:
#.#...#..#
##....#.##
#...##.#..
#..##.....
.#.#.....#
##..#.....
##.#......
..#...##..
.#.##....#
##...##..#

Tile 2143:
##.###.#.#
#..##.##..
###.......
..##.#...#
#.......#.
#.#....##.
...#..####
..##...#.#
#.#..#.##.
#.#.#...##

Tile 2887:
.......##.
#..#..#..#
....#.....
...#..##..
..#.......
#...##..##
..#...##..
#.....#.##
##..#..##.
#...#.####

Tile 3511:
.#.##....#
#.#...##.#
#...##.###
....#.....
..#......#
.###.#..#.
#.........
#.#....###
.......#.#
#..#######

Tile 3911:
.#..#.###.
#...#.##..
.#..#...##
##.#.##.##
....#.#..#
...###....
.....#...#
...##..#..
###.#.#.#.
##.....#.#

Tile 3821:
#####..#..
##..#.....
....##.#.#
#....#....
#...##.#.#
#........#
####......
#.#.#....#
....######
..#...###.

Tile 3539:
#####.##..
#........#
####.#....
.##..#.#.#
#.....#...
#.#......#
##...###.#
.#..#.....
#.#.......
...#...#..

Tile 3251:
....#..##.
.###.#...#
#..#.....#
...#.....#
..#.......
.##..#...#
#.......##
#.....#...
....#..#.#
######.#.#

Tile 2677:
.#...#...#
...#.###..
......##..
#.##.##...
#.#...#.##
#..#####..
......##..
......##.#
#..#..#...
..##.####.

Tile 3011:
#.#..#..##
#.###..#..
#..#..##..
#.#..#...#
##...#####
....#..###
.#..#..#.#
..#...#..#
##.##..#.#
.#.##.....

Tile 1489:
#...##.###
#.#..#....
#.....#..#
##..#.....
...#....##
.##.##.#.#
#.#......#
#........#
....#.....
##.#.#####

Tile 3769:
.....####.
##....####
###....#.#
.##..#.#.#
..........
##....####
#...#..#..
...#.....#
##.#.....#
#...##.###

Tile 2293:
.#..#.#...
####......
##...#....
###.#.#...
.##.##...#
......#.#.
##.....#..
#..#.##.##
.##....##.
.#.....#..

Tile 3947:
.#.#...##.
..........
..#...##.#
..###..#.#
##...#.###
.#..#..#..
#.#....#..
....#.#..#
.#....####
######..#.

Tile 1223:
#..#####.#
###..#..##
##.###....
...##.#...
..#.##.#..
##.###...#
...#..#.##
...#..#...
.#....#..#
#..####...

Tile 3331:
#.....##..
##..###.#.
.##.#...#.
.##..#.#..
#......#..
...#.....#
###.#.#...
.##......#
#..#......
...#...###

Tile 3691:
#..#..#.##
......#..#
#.#..##..#
###.......
#.#....##.
##.#..##..
#......#..
..#.......
...#.#..#.
#..#......

Tile 1289:
#.......#.
##.##....#
####......
.#..#.#..#
#.#.#..###
#..#......
##.#####..
.#........
##.##....#
##.#######

Tile 2857:
.#.#..#.##
.....#.#..
#..#...#..
.##...#..#
##..#..#.#
#..#..#..#
...#......
#.#.#.....
##...#....
....#.##..

Tile 3559:
#.##..##..
..#.##.###
##..#....#
#.#..#..#.
##.####..#
.....#...#
#....#....
##..#.##..
#..#.....#
###.##..##

Tile 2633:
...#.#..##
##.......#
#...##..#.
#.#....#.#
.........#
...#.....#
.#.##....#
...#..#...
#.#.##....
..#..##...

Tile 1973:
#.#.....#.
#.......#.
#....#....
.#.#...##.
.........#
#.......#.
...#.##..#
.##...#...
##..#..#..
####..##.#

Tile 1373:
#####.#..#
##.##..###
#.####...#
..###.#...
....##...#
#...#....#
##.#....##
.......#..
##.#.##.#.
#.###.##.#

Tile 1759:
.#.....##.
#.#..#...#
....###..#
........##
....#.....
.....#..#.
#...#....#
.#..#...#.
...#.#.#..
##...#..##

Tile 1213:
#....###.#
###...##.#
.#.....#.#
#......##.
.#...#.##.
.##.......
....##...#
#.........
.........#
#.....#.##

Tile 2341:
#.....#.#.
...##.#..#
.....##..#
......##.#
#...#....#
..#...###.
..##.#.#.#
.#.#....##
.#.....###
.#.#...##.

Tile 3547:
####.#.#.#
...###...#
#..#.##...
##..#.#...
#....#.#.#
.#.......#
.#.#......
###.....#.
#.#....###
.#.##.#...

Tile 2003:
#####.####
...#..#..#
.#.......#
#.#.#...##
.#.#.#..#.
#......#..
...#..#...
.#...#.#..
#........#
####.###..

Tile 2861:
#..##.##..
..#.#....#
....##.#..
##........
#.........
##.....#.#
##.....##.
####.....#
###..#####
.........#

Tile 3697:
#..##.####
.....#....
#.#.#.#.#.
#.##...###
..##.....#
.#.......#
.##.......
#.#..#...#
.#.###.#..
####.####.

Tile 3929:
.#.##..#.#
##.#....##
....#.#..#
....#.#.#.
##........
...#..#...
###....#.#
#........#
.###.##.##
###..#####

Tile 3527:
#.#.#...#.
####.#....
......#...
.##......#
.#......##
.##.#.#.##
#..#......
#.....#...
.#........
..#..####.

Tile 1777:
.#..#...##
#....###..
..#..##.##
..##...#..
....#.#...
#...##.#..
#..##.#..#
...##.....
.#....#..#
.#..#..###

Tile 1543:
......#...
.#...##...
#...#..#.#
..........
#..##....#
..#.#...##
...#.####.
##....#...
...#..####
.#.#..####

Tile 2063:
##....#...
#.....#...
###.##...#
......#..#
...##..#..
###.#.....
##.....##.
#..#.##...
##.###..##
#....###..

Tile 1181:
#.##...###
####.#....
.........#
####..##.#
.....#..#.
.......#..
..###....#
##..##....
#.#...#..#
.#.#.#...#

Tile 3491:
#...###.##
..##..#.##
.......##.
..........
.....#..#.
#..#......
##....#.#.
...##...#.
..###.....
..#.##..#.

Tile 1873:
...#.....#
...#.#..#.
##.#......
.#...#.###
#.#.#..#..
.....###.#
#..#..#...
....#.....
.....#.#.#
######...#

Tile 2579:
.####...#.
#..#..#..#
.....#...#
#.#..#...#
#.....##..
......#..#
#......##.
.#...##...
.#...##...
.##.####..

Tile 1481:
.#.#.#####
..#.#.##..
.###...#.#
...##.....
..#.#.#.#.
.#.......#
##.#....#.
#.#...#...
.###..#...
......##.#

Tile 2417:
.#..#..#.#
.#.#.....#
.###..##.#
#.#.#.....
#....#.###
..#..#....
#....#.#..
####....##
..#.#...##
....######

Tile 3581:
..##.....#
.....##..#
#.........
#....##..#
#..#....#.
#.....#..#
.#..#.#.#.
...#......
.....##..#
#.........

Tile 3593:
#.##.###..
###.....##
##.#....#.
###.#....#
###....#.#
#.#..#..##
......#.##
...#....#.
.#...#..#.
..#####..#

Tile 3167:
#...#.#.#.
......#.##
##.##.#.##
#...#.##.#
....#...#.
..#....##.
...#...##.
...##..#..
....#.##.#
##.#....#.

Tile 1439:
...##..###
#.#......#
..#..###.#
....#.#...
#.........
......#..#
..#.#.#..#
##.#.#....
..#...#..#
#.###.#...

Tile 1249:
..#.##...#
#.#......#
.......#..
##.#.#.#.#
.#..#..#..
..#.#..#.#
.....##.#.
#........#
..#..##.##
..#..#####

Tile 2687:
##...##...
###.###.#.
#...###..#
.#.......#
....#.#...
.....#####
##.#####..
#....#....
..#.####.#
##....#.#.

Tile 2693:
..#..#..#.
....#..###
....##....
.#.##.....
.#..###...
..##.#....
#.........
....##.##.
..#..#....
.#.#......

Tile 1741:
.#.###..##
......####
#.......##
#.#......#
##..#...#.
##.....#.#
#..#......
..##.#..##
#..#......
#.#..###.#

Tile 3413:
...####.#.
.#..#.##..
#....#.##.
##.#.....#
##.###..##
.......###
.#....###.
#....##..#
##.####..#
....#.###.

Tile 3191:
.....####.
##.##..#..
.##.#.##.#
.......###
....####..
.#.#..#.#.
...#...#..
##..#..#.#
...#..#...
..##..#.#.

Tile 2897:
#.#######.
...#....#.
#.....##.#
###.#...#.
##.#####.#
..#.##..##
#.##......
##.#.##..#
#.#....#..
#.##.#.###

Tile 2017:
##.##...##
#...#.##..
#..#.#...#
.##.......
##.......#
##..#.#..#
##.#.#.#.#
..........
..........
..######.#

Tile 2939:
#...##.##.
.....#.##.
....#.#...
#.#......#
.#.....#.#
.........#
###.....##
......#..#
#..#..##..
.##..#.##.

Tile 1753:
#...#.#.##
.#...#...#
###..#.###
#..##....#
#..#......
#.##...#..
..#...#...
#..#......
.#.......#
....#.#.##

Tile 3229:
#..####.#.
#.....#..#
......##..
#.#...##.#
#...#...##
#.#....#.#
.#..##..#.
#..#.....#
#..##.....
.#.#.#..##

Tile 1367:
####.....#
...#.##...
...#...#..
.#.###..#.
.........#
.#........
..........
.#...###.#
##........
...##..#.#

Tile 2851:
..#.#...##
#.....##.#
.##.#..#.#
#...###..#
###...#...
....#..#.#
..#.......
#.....#...
...#.#...#
.###..#..#

Tile 2357:
....##.#.#
###...#.##
####..##.#
#.####...#
#...##...#
#.#......#
#..##.#.#.
#.#....#.#
.###...#..
####..#.##

Tile 1697:
#..#.#.##.
.......#..
...##....#
##........
....#....#
##.#.....#
.##......#
#....#..#.
##.##...##
#....#...#

Tile 1571:
#.###...#.
##..#..#..
.........#
...#.#.#..
#........#
#..##.#...
##...##.#.
..........
....#.#...
.##.....#.

Tile 3323:
#.#.#..###
#...#...##
.......#.#
#.##......
..#.#..##.
#.......#.
....####.#
....##...#
..##....##
######.###

Tile 3461:
#....##.#.
....#.....
#......##.
##.....##.
#..#...##.
.#.......#
##.#......
..........
.....#..##
.....#.###

Tile 2719:
.#.#.#....
..#..#.##.
..##...###
..#..#...#
##.......#
.#........
.##..#....
..##..#...
..#....#..
.#.#.#..#.

Tile 3359:
.###...#.#
.....###.#
#..####.#.
.....##..#
..#.#...#.
#.#..###..
..#....#.#
....#.#..#
.....#..#.
#.###.#..#

Tile 3803:
.####.#..#
...#...###
.......##.
.......##.
#..#..#..#
##...#....
....##....
##........
..#..#####
..#..##...

Tile 3019:
##..###.#.
..#.......
##..#.##.#
##......#.
#......#..
#.#....#..
.###.###.#
#..#.##..#
###.##.#.#
.###.###.#

Tile 2791:
......#.#.
#....#....
##...#####
....##....
#.....##.#
..##......
#.#...#..#
...##...#.
..##....#.
##.##..#..

Tile 3881:
#....##..#
...#..#..#
.###..#..#
...#....##
#...#..#.#
#.#.#..#.#
#..##.....
...#......
#.#....#..
.#..##.###

Tile 2087:
.#..#.#...
###....###
.###..#.##
........##
###.##..##
...#...#.#
#...#....#
##..#....#
#..####.#.
##..#####.

Tile 1789:
######.#..
........#.
..#...##.#
.#.......#
.#...#....
#..#.#..##
#####.#..#
#...###..#
.#.#....##
####.##.#.

Tile 2539:
#.###.#..#
..#..#...#
##.##.#...
#.....##..
#..##..#..
..###.##.#
#..###...#
.###.#.#..
#...#.....
..###.##..

Tile 2111:
####..###.
#....###..
..#.....##
#....##.##
#.....#...
#..#.#....
...#..####
##..##..#.
##.....#.#
#.#...#.#.

Tile 1433:
#.....#..#
.#.###.#.#
.#...#.#.#
.......###
#..##.#...
.#...##.#.
#..#....##
#......#..
....#..#.#
..#.#..##.

Tile 1667:
..##......
#..#....#.
.##.#..#.#
.....#....
#.#.##..#.
...##.....
..#.#....#
#.#..#...#
...#...##.
....#....#

Tile 2389:
.#.#...#..
.#.......#
.....#....
#...###..#
..........
.#........
.#.###.#.#
#....#..#.
..#......#
##...#...#

Tile 1069:
...###..##
...#.....#
##......##
....##....
..#..##..#
##..#..#.#
##.#.#.#.#
.#..###..#
#.#.......
.#.#.#....

Tile 1103:
..###.##..
...##..#.#
#....##..#
....#..#.#
#....#.#..
###....###
..#...##..
..##.....#
#........#
.####..#..

Tile 3761:
....#.##..
###.......
#...#.....
..##.#...#
#........#
.###......
...#..#...
...#.#.#..
#....#.#.#
....#...#.

Tile 2473:
........##
.#.#..#...
.#........
.####.#.##
##..##...#
##.....#..
###.#..#.#
..........
.#.#..##.#
..#....#.#

Tile 1987:
...#..#.#.
......#...
#....#.###
..#....#..
..#..##..#
........#.
#..#.....#
...#..#..#
.......#.#
...###.##.

Tile 1187:
..#.#.#..#
##.#...##.
#......#.#
....#....#
..##...#.#
#..#..#.##
..........
..##...#.#
...####..#
.#.#.#####

Tile 2699:
###.#.##.#
.#.#####.#
.#..#..#..
.###....##
..#..##..#
.....#...#
..........
#...##...#
#.........
##..#..#.#

Tile 3643:
..##...#..
#..#..#.##
#.###.####
..##..##..
......#...
##.##..#..
...#.##.##
....#..#.#
##..#....#
#....#...#

Tile 3463:
..###.##.#
......##.#
#........#
......##.#
##.......#
##..#..#.#
##.......#
##......#.
##.#.##...
.###..#.##

Tile 1117:
#.#.##....
..#..#.###
.#..#.....
...#.#....
........#.
##.###...#
..#..#.#.#
....#..#..
..#.#....#
..#.#..#..

Tile 1163:
.##.##..##
....#..#..
##..#..#..
#..#.....#
#..#.....#
..#.##....
...#.#....
..###..#.#
...#...#.#
###.######

Tile 3557:
#.#....#..
....####.#
.#....####
..#...###.
#......#..
.......#..
##....#...
##.....#..
...#..#.#.
...###.#..

Tile 2467:
.####....#
.#.#..##.#
####......
......#.#.
#.#....#.#
##.....#..
..#....#.#
..#.##...#
.#.....###
#...##.##.

Tile 1471:
.###..#.##
##.#...##.
.#...#....
....##..#.
........#.
##....##.#
###..##.#.
#....###.#
##.....##.
#..#..##.#

Tile 3931:
#....#..##
#...#..#..
.#..######
#.###...#.
....#.##.#
#.#...####
#....#..#.
....##.#..
#..#..####
#.#.#.....

Tile 2029:
##.#.#####
#.#......#
#...##...#
#...#.....
#..##.....
#.....##.#
....##....
..##.#.###
###.#.###.
..####.##.

Tile 1913:
#..###.###
.......###
.#..#.####
.#..#.#...
..#.......
.#....###.
.###..#.#.
#....#..#.
#.#..#.#..
.#..#.#.#.

Tile 2213:
..#.##.###
......###.
..#..#...#
#..#..#.##
#....###..
...#....#.
#.##.#..#.
##.#...#..
.##....###
####.#..#.

Tile 1511:
###.#...##
.##.....#.
.##...#..#
...##.##..
#.#..#.#.#
##...###.#
###..#.###
.##.##..#.
#......#..
###.....##

Tile 2243:
#..#.#...#
##...#....
.....#.#.#
....##..#.
#..######.
.#..#.##..
#.........
...#.##.#.
.#.......#
.##...#.##

Tile 3701:
...#######
#..#...##.
...####..#
..#..#...#
##........
#.....#..#
##..#.#...
##.#.##.#.
.##.......
###.#...##

Tile 3137:
.#.####...
#..#.#...#
.......#.#
#..#.....#
#.....#...
#...###.##
.###...#.#
##......##
#.#....#.#
##...####.

Tile 2437:
#...#..###
.#.#....#.
....#...#.
.......#.#
#.#...##.#
###..#...#
#.##..#...
....#.....
#.#.#.##..
.#.#.#.###

Tile 1009:
..#.#.#...
...#..##..
##...##..#
........##
##...###.#
#....#...#
..#..#...#
..####.###
#.........
####..#..#

Tile 2399:
..####.#..
###..#....
#..#..##..
...#.#....
##.##.....
##.###..#.
##..##..##
###....#.#
..#......#
#.###..##.

Tile 2843:
.....#....
......#...
.##.#....#
..#....#..
.##.....##
.#...##.#.
####..##..
.##....##.
....##...#
#..###...#

Tile 1193:
##.....###
.......#..
.#...#.#..
#.#...#.##
..#.....##
.#.....#..
#...#....#
##.#..#.#.
##.....#.#
#..#.....#

Tile 1951:
###......#
..........
..........
#####.....
#.##..#...
.........#
##.##.....
#.#..#.##.
.#...#...#
..#.###...

Tile 1879:
#...#.....
.#.......#
###.......
#####.....
#..#.#....
...###.##.
#.......#.
#.#......#
.#..##....
..#.##.###

Tile 3469:
..####...#
#...#...#.
......###.
........#.
####.....#
#...#...#.
...#....##
#..#..#..#
..#...##.#
#####..#.#

Tile 2161:
####.####.
###...#.##
.##...#...
#..#...#..
##...##.#.
#.........
#...##...#
....#.#..#
..#.##..##
#.......##

Tile 2083:
##.##.#..#
#.##.#..#.
...#.....#
##.#.##.#.
.....#..#.
#.......#.
...###.#.#
....##...#
#.##.#...#
##.#...###

Tile 2089:
#.#.###.#.
#..##.....
.....#...#
#.........
.##...####
#...##...#
.#.......#
....#...##
#..##....#
.....##.#.

Tile 1051:
#.....##.#
.....##.#.
#...#....#
.#.#......
........#.
.......#..
##....#.##
#.......##
#........#
####.##.#.

Tile 3347:
....##.#..
#.#.#..#.#
##........
..#....#..
##...##...
.##.#.....
#........#
#..###....
.....#...#
##.##.#..#

Tile 2927:
#.##......
...#..#.##
.#.#.#.##.
..........
##....#...
##.#...#..
....##.##.
#....#.#..
..#.....#.
##.###.#..

Tile 1301:
#..##.#.#.
#.#......#
..#...#..#
##....#..#
#.........
.......#.#
....##.#..
#..#.###..
..#.######
...###.###

Tile 2459:
#..###....
...###.###
##........
##..#..#..
##.#.##.##
#.##.#..#.
#..##..##.
.#...##..#
#........#
..#.######

Tile 1583:
.#.#..#..#
#.#.#....#
.##.......
.........#
#....#....
##...###.#
#.#.......
.........#
#...#....#
#.###..#.#

Tile 3533:
.#.##.#..#
.#.......#
........#.
.#...#...#
#.........
.......#.#
...#...#..
##..#..#.#
...#.###..
.###..####

Tile 1993:
#.####..#.
..##.#.#.#
.#.#......
.#........
..#.......
#.##..#..#
##..#.....
.#.##..#..
........#.
.#.#.###.#

Tile 3853:
..#.####.#
##....##.#
..#......#
....#.....
.....#.##.
......#..#
..#..#.#.#
##....#...
###.#..##.
##...#.#.#

Tile 2113:
#..#.#.#.#
#.....#.##
#.....#..#
.##....#.#
##.#.#####
#..#......
...#...#..
...#.#..##
.......##.
..##....##

Tile 3319:
####.#..##
##....#.#.
#.......#.
......#..#
####...##.
..........
##.....#..
..#..#..##
#...#.....
.##..#...#

Tile 3847:
...##..#.#
..#.##...#
...#..####
#..#.#.#..
#........#
#....##..#
#....#..##
.#.#.##.##
.####.....
#....##..#

Tile 1283:
..##..###.
##.......#
#.#.#.....
.#.#....#.
..#..#....
#...#.....
##.......#
.##.#...##
##.####...
##..#..###

Tile 2957:
#.####.#.#
#..#..##..
#..###...#
#.#..#.#..
#.......#.
#.#..#...#
######....
#.......##
#...#...#.
.##..#.##.

Tile 1097:
.###.#.###
#......##.
#........#
....#...#.
..##..#.#.
#....#..##
.###...##.
..##.#...#
#..#.####.
#.#.......

Tile 1399:
#.###..###
#...##.###
....#.#...
#...##.#..
..#...#..#
#...###...
.......#..
..#.#.#...
...##...#.
...##..##.

Tile 1451:
#.#...#.#.
#........#
#.#....#.#
###.#.....
....##....
.##.#..#..
.#.####..#
..#..###.#
...#...#.#
#...##.#.#

Tile 1559:
#..#.#.###
......#...
.....#..##
#.........
##..#.....
...#...#..
##.#.#....
.....#.##.
#...#.#.#.
...#####..

Tile 3391:
#.#.#.#..#
##..#.....
.#...###..
......#..#
#.#.....#.
...#..#...
.#......#.
.......#..
.....#.#.#
#.#.#.##.#

Tile 2423:
#.#.#....#
#......#..
#.#.#.#.##
...#.#.#.#
....#.#.#.
.......#..
.##.....#.
.........#
#.#..#...#
...##..##.

Tile 2297:
.....#####
#..#......
#...#.....
##...#.#..
.......##.
#.......#.
###....###
..#.....#.
.....##...
##.##.###.

Tile 2011:
#######...
#.#...#.#.
...##..#..
...##..#.#
......#..#
#..#.....#
...#.#....
....#.#...
..#.###..#
#.#####.#.

Tile 1049:
#.#...#...
.......###
#..#.#..##
##.......#
.#.###...#
##....#...
...#.##...
........#.
...#..#.#.
##...##.##

Tile 3943:
..#...####
...#.##...
#.#.###...
.#...###.#
....#.##..
.##...#..#
####.....#
####.##.#.
##...#....
.##.#...#.

Tile 2039:
#####.#..#
#.#....###
.....#....
##.....#.#
.......#..
#......#..
..#...#..#
#.#...#...
..##...#..
##.#######

Tile 1297:
.#..##.###
#.....#..#
###..##..#
.##..#..##
...#......
#..#....##
..#......#
...##.#..#
....##....
#..###.#..

Tile 1597:
.#..#.##..
###......#
#...##...#
.#.#....##
...##.##..
#.###....#
###.#.....
..#....#.#
...##....#
###.##....

Tile 1319:
...#.##..#
#.#####...
..........
.#..#..#..
#...#.#.#.
.#.##..#..
###.......
#...#.##..
...#.....#
##.#####.#

Tile 2333:
#..##..##.
...#...#.#
..##.#....
#....#.##.
..##..##.#
..##..###.
...##.#..#
.....#.#.#
#......#.#
########..

Tile 1423:
#.##..##..
#.##.....#
#.#..##...
##.#####..
...#.#..#.
.#..#.#.#.
#.##....##
...###..##
#.#.#...#.
#..##.###.

Tile 1303:
.#########
##..#....#
..#.#.####
..........
#...#.....
#.#..#...#
###.#.....
.##.#....#
#.#.#..#..
##..##..#.
'''

# COMMAND ----------

import dataclasses
import enum
import functools
import math


Side = enum.IntEnum('Side', ['UP', 'RIGHT', 'DOWN', 'LEFT'], start=0)


@dataclasses.dataclass(frozen=True)
class Config:
  tile_id: int
  rotation: int
  h_flipped: bool
  v_flipped: bool


def generate_configs(tile_id: int):
  configs = []
  for rotation in range(4):
    for h_flipped in [False, True]:
      for v_flipped in [False, True]:
        configs.append(Config(tile_id, rotation, h_flipped, v_flipped))
  return configs


# FIXME: This doesn't work!!!???
@functools.cache
def get_active(config: Config):
  tile_definition = tiles[config.tile_id]
  if config.h_flipped:
    tile_definition = [line[::-1] for line in tile_definition]
  if config.v_flipped:
    tile_definition = tile_definition[::-1]
  for _ in range(config.rotation):
    tile_definition = list(zip(*(line[::-1] for line in tile_definition)))
    
  return frozenset({(row, col) for row, line in enumerate(tile_definition) for col, c in enumerate(line) if c == '#'})


@functools.cache
def get_edges(config: Config):
  active = get_active(config)
  return (
    frozenset({col for row, col in active if row == 0}), # Up
    frozenset({row for row, col in active if col == 9}), # Right
    frozenset({col for row, col in active if row == 9}), # Down
    frozenset({row for row, col in active if col == 0})  # Left
  )


tiles = {}
for tile_string in inp.split('\n\n'):
  tile_id, *tile_definition = tile_string.splitlines()
  tile_id = int(tile_id[5:-1])
  tiles[tile_id] = tile_definition

connectivity = {} # tile_id: (max number of sides that could be connected at once)
for tile_id in tiles:
  edges = get_edges(Config(tile_id, 0, False, False))
  
  edges_other = set()
  for tile_id_other in tiles:
    if tile_id_other == tile_id:
      continue

    for config_other in generate_configs(tile_id_other):
      edges_other.update(get_edges(config_other))
    
  connectivity[tile_id] = sum(edge in edges_other for edge in edges)

corner_tile_ids = {tile_id for tile_id, connections in connectivity.items() if connections == 2}
answer = math.prod(corner_tile_ids)
print(answer)

# COMMAND ----------

# MAGIC %md <article class="day-desc"><h2 id="part2">--- Part Two ---</h2><p>Now, you're ready to <em>check the image for sea monsters</em>.</p>
# MAGIC <p>The borders of each tile are not part of the actual image; start by removing them.</p>
# MAGIC <p>In the example above, the tiles become:</p>
# MAGIC <pre><code>.#.#..#. ##...#.# #..#####
# MAGIC ###....# .#....#. .#......
# MAGIC ##.##.## #.#.#..# #####...
# MAGIC ###.#### #...#.## ###.#..#
# MAGIC ##.#.... #.##.### #...#.##
# MAGIC ...##### ###.#... .#####.#
# MAGIC ....#..# ...##..# .#.###..
# MAGIC .####... #..#.... .#......
# MAGIC 
# MAGIC #..#.##. .#..###. #.##....
# MAGIC #.####.. #.####.# .#.###..
# MAGIC ###.#.#. ..#.#### ##.#..##
# MAGIC #.####.. ..##..## ######.#
# MAGIC ##..##.# ...#...# .#.#.#..
# MAGIC ...#..#. .#.#.##. .###.###
# MAGIC .#.#.... #.##.#.. .###.##.
# MAGIC ###.#... #..#.##. ######..
# MAGIC 
# MAGIC .#.#.### .##.##.# ..#.##..
# MAGIC .####.## #.#...## #.#..#.#
# MAGIC ..#.#..# ..#.#.#. ####.###
# MAGIC #..####. ..#.#.#. ###.###.
# MAGIC #####..# ####...# ##....##
# MAGIC #.##..#. .#...#.. ####...#
# MAGIC .#.###.. ##..##.. ####.##.
# MAGIC ...###.. .##...#. ..#..###
# MAGIC </code></pre>
# MAGIC <p>Remove the gaps to form the actual image:</p>
# MAGIC <pre><code>.#.#..#.##...#.##..#####
# MAGIC ###....#.#....#..#......
# MAGIC ##.##.###.#.#..######...
# MAGIC ###.#####...#.#####.#..#
# MAGIC ##.#....#.##.####...#.##
# MAGIC ...########.#....#####.#
# MAGIC ....#..#...##..#.#.###..
# MAGIC .####...#..#.....#......
# MAGIC #..#.##..#..###.#.##....
# MAGIC #.####..#.####.#.#.###..
# MAGIC ###.#.#...#.######.#..##
# MAGIC #.####....##..########.#
# MAGIC ##..##.#...#...#.#.#.#..
# MAGIC ...#..#..#.#.##..###.###
# MAGIC .#.#....#.##.#...###.##.
# MAGIC ###.#...#..#.##.######..
# MAGIC .#.#.###.##.##.#..#.##..
# MAGIC .####.###.#...###.#..#.#
# MAGIC ..#.#..#..#.#.#.####.###
# MAGIC #..####...#.#.#.###.###.
# MAGIC #####..#####...###....##
# MAGIC #.##..#..#...#..####...#
# MAGIC .#.###..##..##..####.##.
# MAGIC ...###...##...#...#..###
# MAGIC </code></pre>
# MAGIC <p>Now, you're ready to search for sea monsters! Because your image is monochrome, a sea monster will look like this:</p>
# MAGIC <pre><code>                  # 
# MAGIC #    ##    ##    ###
# MAGIC  #  #  #  #  #  #   
# MAGIC </code></pre>
# MAGIC <p>When looking for this pattern in the image, <em>the spaces can be anything</em>; only the <code>#</code> need to match. Also, you might need to rotate or flip your image before it's oriented correctly to find sea monsters. In the above image, <em>after flipping and rotating it</em> to the appropriate orientation, there are <em>two</em> sea monsters (marked with <code><em>O</em></code>):</p>
# MAGIC <pre><code>.####...#####..#...###..
# MAGIC #####..#..#.#.####..#.#.
# MAGIC .#.#...#.###...#.##.<em>O</em>#..
# MAGIC #.<em>O</em>.##.<em>O</em><em>O</em>#.#.<em>O</em><em>O</em>.##.<em>O</em><em>O</em><em>O</em>##
# MAGIC ..#<em>O</em>.#<em>O</em>#.<em>O</em>##<em>O</em>..<em>O</em>.#<em>O</em>##.##
# MAGIC ...#.#..##.##...#..#..##
# MAGIC #.##.#..#.#..#..##.#.#..
# MAGIC .###.##.....#...###.#...
# MAGIC #.####.#.#....##.#..#.#.
# MAGIC ##...#..#....#..#...####
# MAGIC ..#.##...###..#.#####..#
# MAGIC ....#.##.#.#####....#...
# MAGIC ..##.##.###.....#.##..#.
# MAGIC #...#...###..####....##.
# MAGIC .#.##...#.##.#.#.###...#
# MAGIC #.###.#..####...##..#...
# MAGIC #.###...#.##...#.##<em>O</em>###.
# MAGIC .<em>O</em>##.#<em>O</em><em>O</em>.###<em>O</em><em>O</em>##..<em>O</em><em>O</em><em>O</em>##.
# MAGIC ..<em>O</em>#.<em>O</em>..<em>O</em>..<em>O</em>.#<em>O</em>##<em>O</em>##.###
# MAGIC #.#..##.########..#..##.
# MAGIC #.#####..#.#...##..#....
# MAGIC #....##..#.#########..##
# MAGIC #...#.....#..##...###.##
# MAGIC #..###....##.#...##.##.#
# MAGIC </code></pre>
# MAGIC <p>Determine how rough the waters are in the sea monsters' habitat by counting the number of <code>#</code> that are <em>not</em> part of a sea monster. In the above example, the habitat's water roughness is <em><code>273</code></em>.</p>
# MAGIC <p><em>How many <code>#</code> are not part of a sea monster?</em></p>
# MAGIC </article>

# COMMAND ----------

def place(row, col, remaining_tile_ids, arrangement):
  if row == len(arrangement):
    return True

  col2 = col + 1
  row2 = row
  if col2 == len(arrangement[0]):
    col2 = 0
    row2 += 1
    
  possible_tiles = set(remaining_tile_ids)
  
  # Corner position must be a corner tile ID
  if row in [0, len(arrangement) - 1] and col in [0, len(arrangement[0]) - 1]:
    possible_tiles.intersection_update(corner_tile_ids)

  possible_configs = {config for tile_id in possible_tiles for config in generate_configs(tile_id)}
  
  # Sides must align with the tile above and the tile to the left
  if col > 0:
    possible_configs.intersection_update(side_to_config[(get_edges(arrangement[row][col - 1])[Side.RIGHT], Side.LEFT)])
  if row > 0:
    possible_configs.intersection_update(side_to_config[(get_edges(arrangement[row - 1][col])[Side.DOWN], Side.UP)])

  for config in possible_configs:
    arrangement[row][col] = config
    if place(row2, col2, remaining_tile_ids - {config.tile_id}, arrangement):
      return True

  return False


side_to_config = {} # (edge, side): [config, ...]
for tile_id in tiles:
  for config in generate_configs(tile_id):
    for edges, side in zip(get_edges(config), Side):
      side_to_config[(edges, side)] = side_to_config.get((edges, side), frozenset()).union({config})

tiles_per_side = int(math.sqrt(len(tiles)))
arrangement = [[None for _ in range(tiles_per_side)] for _ in range(tiles_per_side)]
place(0, 0, frozenset(tiles), arrangement) # < 1 second

# COMMAND ----------

active = set()
for row, line in enumerate(arrangement):
  for col, config in enumerate(line):
    active.update({(r - 1 + 8 * row, c - 1 + 8 * col) for r, c in get_active(config) if r not in [0, 9] and c not in [0, 9]})

tiles['monster'] = '''                  # 
#    ##    ##    ###
 #  #  #  #  #  #   '''.splitlines()

target_configs = generate_configs('monster')
target_actives = [get_active(config) for config in target_configs]

monster = set()
for row in range(tiles_per_side * 8):
  for col in range(tiles_per_side * 8):
    for target in target_actives:
      offset_target = {(r + row, c + col) for r, c in target}
      if offset_target.issubset(active):
        monster.update(offset_target)

answer = len(active) - len(monster)
print(answer)
